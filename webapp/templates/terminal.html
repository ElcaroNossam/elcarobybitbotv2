<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElCaro Trading Terminal v2.0 - Professional Trading</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="/static/css/terminal-advanced.css" rel="stylesheet">
    <script src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root {
            /* Unified ElCaro Design System */
            --bg-primary: #0a0a0f;
            --bg-secondary: #111118;
            --bg-tertiary: #16161f;
            --bg-card: #16161f;
            --bg-hover: #1e1e28;
            --accent: #6366f1;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --green: #22c55e;
            --accent-green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --accent-red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --accent-yellow: #f59e0b;
            --accent-cyan: #06b6d4;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.06);
            --border-color: rgba(255, 255, 255, 0.06);
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            --gradient-green: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --gradient-red: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            /* Exchange-specific colors */
            --bybit-color: #f7a600;
            --hl-color: #00ff88;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); height: 100vh; overflow: hidden; }
        
        .bg-pattern {
            position: fixed; inset: 0; pointer-events: none; z-index: 0;
            background: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(34, 197, 94, 0.06) 0%, transparent 40%);
        }
        
        /* Layout */
        .terminal-layout {
            position: relative; z-index: 1;
            display: grid;
            grid-template-columns: 300px 1fr 360px;
            grid-template-rows: 28px 56px 1fr 220px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }
        
        /* Ticker Tape */
        .ticker-tape {
            grid-column: 1 / -1;
            background: var(--bg-primary);
            overflow: hidden;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        .ticker-track {
            display: flex;
            animation: ticker-scroll 60s linear infinite;
            width: fit-content;
        }
        .ticker-track:hover { animation-play-state: paused; }
        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .ticker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 20px;
            font-size: 0.75rem;
            white-space: nowrap;
            cursor: pointer;
            transition: background 0.15s;
        }
        .ticker-item:hover { background: var(--bg-hover); }
        .ticker-symbol { font-weight: 600; color: var(--text-primary); }
        .ticker-price { font-family: var(--font-mono); }
        .ticker-change { font-family: var(--font-mono); font-weight: 500; }
        .ticker-change.up { color: var(--green); }
        .ticker-change.down { color: var(--red); }
        
        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.1rem; text-decoration: none; color: var(--text-primary); }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #8b5cf6); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        
        .symbol-selector {
            display: flex; align-items: center; gap: 12px;
            background: var(--bg-card); padding: 8px 16px; border-radius: 10px; cursor: pointer;
        }
        .symbol-info { display: flex; flex-direction: column; }
        .symbol-name { font-weight: 600; font-size: 1rem; }
        .symbol-pair { font-size: 0.75rem; color: var(--text-muted); }
        .symbol-price { font-family: var(--font-mono); font-size: 1.1rem; font-weight: 600; }
        .symbol-change { font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }
        .symbol-change.positive { background: var(--green-dim); color: var(--green); }
        .symbol-change.negative { background: var(--red-dim); color: var(--red); }
        
        .header-center { display: flex; gap: 24px; }
        .market-stat { display: flex; flex-direction: column; align-items: center; }
        .market-stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        .market-stat-value { font-family: var(--font-mono); font-size: 0.85rem; font-weight: 500; }
        
        .header-right { display: flex; align-items: center; gap: 12px; }
        .exchange-badge { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-card); border-radius: 8px; font-size: 0.8rem; }
        .exchange-badge.bybit { border: 1px solid #f7a600; }
        .exchange-badge.hl { border: 1px solid #00ff88; }
        .ws-status { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-muted); }
        .ws-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); }
        .ws-dot.connected { background: var(--green); box-shadow: 0 0 8px var(--green); }
        
        /* Left Panel - Order Book & Trades */
        .left-panel { background: var(--bg-secondary); display: flex; flex-direction: column; overflow: hidden; }
        .panel-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .panel-tab { flex: 1; padding: 12px; text-align: center; font-size: 0.8rem; font-weight: 500; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .panel-tab:hover { color: var(--text-primary); }
        .panel-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .orderbook { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 8px; }
        .orderbook-controls { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; margin-bottom: 6px; }
        .orderbook-grouping { display: flex; gap: 4px; }
        .group-btn { padding: 3px 8px; font-size: 0.65rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text-muted); font-family: var(--font-mono); }
        .group-btn:hover { border-color: var(--accent); color: var(--text-primary); }
        .group-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .orderbook-view-btns { display: flex; gap: 2px; }
        .view-btn { padding: 4px 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 0.7rem; }
        .view-btn:hover { border-color: var(--accent); }
        .view-btn.active { background: var(--accent); border-color: var(--accent); }
        .view-btn i { color: var(--text-muted); }
        .view-btn.active i { color: white; }
        
        .orderbook-header { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 6px 8px; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .orderbook-asks, .orderbook-bids { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .orderbook-asks { justify-content: flex-end; }
        .orderbook-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 2px 8px; font-size: 0.7rem; font-family: var(--font-mono); position: relative; cursor: pointer; transition: background 0.1s; }
        .orderbook-row:hover { background: var(--bg-hover); }
        .orderbook-row:hover .price { text-decoration: underline; }
        .orderbook-row .depth { position: absolute; right: 0; top: 0; bottom: 0; opacity: 0.12; pointer-events: none; }
        .orderbook-row.ask .price { color: var(--red); }
        .orderbook-row.ask .depth { background: linear-gradient(to left, var(--red), transparent); }
        .orderbook-row.bid .price { color: var(--green); }
        .orderbook-row.bid .depth { background: linear-gradient(to left, var(--green), transparent); }
        .orderbook-row .size { text-align: center; }
        .orderbook-row .total { text-align: right; color: var(--text-muted); }
        .orderbook-row.flash-green { animation: flash-green 0.3s; }
        .orderbook-row.flash-red { animation: flash-red 0.3s; }
        @keyframes flash-green { 0%, 100% { background: transparent; } 50% { background: var(--green-dim); } }
        @keyframes flash-red { 0%, 100% { background: transparent; } 50% { background: var(--red-dim); } }
        
        .orderbook-spread { display: flex; justify-content: space-between; align-items: center; padding: 6px 12px; background: var(--bg-card); font-size: 0.75rem; border-radius: 6px; margin: 4px 0; }
        .spread-price { font-family: var(--font-mono); font-weight: 600; font-size: 0.9rem; }
        .spread-price.up { color: var(--green); }
        .spread-price.down { color: var(--red); }
        .spread-info { display: flex; gap: 12px; font-size: 0.7rem; color: var(--text-muted); }
        .spread-info span { font-family: var(--font-mono); }
        
        .recent-trades { flex: 1; overflow-y: auto; padding: 8px; display: none; }
        .recent-trades.active { display: block; }
        .trades-header { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 6px 8px; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }
        .trade-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 3px 8px; font-size: 0.7rem; font-family: var(--font-mono); }
        .trade-row.buy .price { color: var(--green); }
        .trade-row.sell .price { color: var(--red); }
        .trade-row .time { color: var(--text-muted); text-align: right; }
        
        /* Main Chart */
        .chart-area { background: var(--bg-primary); position: relative; }
        #tradingview_chart { width: 100%; height: 100%; }
        
        /* Right Panel - Order Form */
        .right-panel { background: var(--bg-secondary); display: flex; flex-direction: column; overflow: hidden; }
        .balance-bar { display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
        .balance-item { display: flex; flex-direction: column; }
        .balance-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        .balance-value { font-family: var(--font-mono); font-weight: 600; }
        .balance-value.positive { color: var(--green); }
        .balance-value.negative { color: var(--red); }
        
        .order-form { flex: 1; padding: 16px; overflow-y: auto; }
        
        /* Margin Mode Selector */
        .margin-mode-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: var(--bg-card); border-radius: 8px; }
        .margin-mode-btns { display: flex; gap: 4px; }
        .margin-mode-btn { padding: 5px 12px; font-size: 0.7rem; font-weight: 500; background: transparent; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-muted); transition: all 0.15s; }
        .margin-mode-btn:hover { border-color: var(--accent); color: var(--text-primary); }
        .margin-mode-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .margin-mode-btn.cross.active { background: var(--yellow); border-color: var(--yellow); color: #000; }
        .leverage-quick { font-size: 0.8rem; font-weight: 600; cursor: pointer; padding: 5px 10px; background: var(--bg-primary); border-radius: 6px; font-family: var(--font-mono); color: var(--accent); }
        .leverage-quick:hover { background: var(--bg-hover); }
        
        .order-type-tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .order-type-tab { flex: 1; padding: 10px; text-align: center; font-size: 0.8rem; font-weight: 500; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .order-type-tab:hover { border-color: var(--accent); }
        .order-type-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .side-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
        .side-btn { padding: 14px; text-align: center; font-weight: 600; border-radius: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .side-btn.buy { background: var(--green-dim); color: var(--green); }
        .side-btn.buy:hover, .side-btn.buy.active { background: var(--green); color: white; box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3); }
        .side-btn.sell { background: var(--red-dim); color: var(--red); }
        .side-btn.sell:hover, .side-btn.sell.active { background: var(--red); color: white; box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3); }
        
        /* Advanced Options */
        .order-options { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .order-option { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: var(--text-muted); cursor: pointer; }
        .order-option input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer; }
        .order-option:hover { color: var(--text-primary); }
        
        .form-group { margin-bottom: 12px; }
        .form-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px; }
        .form-label span { color: var(--text-muted); font-family: var(--font-mono); }
        .form-input-wrap { position: relative; }
        .form-input { width: 100%; padding: 12px 14px; padding-right: 60px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem; font-family: var(--font-mono); }
        .form-input:focus { outline: none; border-color: var(--accent); }
        .form-suffix { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.85rem; }
        
        .leverage-slider { margin-bottom: 14px; }
        .leverage-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .leverage-value { font-family: var(--font-mono); font-weight: 600; color: var(--accent); }
        .slider { width: 100%; height: 6px; border-radius: 3px; background: var(--bg-card); appearance: none; cursor: pointer; }
        .slider::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4); }
        .leverage-marks { display: flex; justify-content: space-between; margin-top: 6px; }
        .leverage-marks span { font-size: 0.7rem; color: var(--text-muted); cursor: pointer; }
        .leverage-marks span:hover { color: var(--accent); }
        
        .percent-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 16px; }
        .percent-btn { padding: 8px; text-align: center; font-size: 0.8rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .percent-btn:hover { border-color: var(--accent); color: var(--accent); }
        
        .tp-sl-section { background: var(--bg-card); border-radius: 10px; padding: 12px; margin-bottom: 16px; }
        .tp-sl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tp-sl-toggle { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .toggle-switch { width: 36px; height: 20px; background: var(--bg-primary); border-radius: 10px; position: relative; cursor: pointer; }
        .toggle-switch.active { background: var(--accent); }
        .toggle-switch::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s; }
        .toggle-switch.active::after { transform: translateX(16px); }
        .tp-sl-mode { display: flex; gap: 4px; }
        .tp-sl-mode .group-btn { padding: 4px 8px; font-size: 0.7rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); cursor: pointer; }
        .tp-sl-mode .group-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .tp-sl-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tp-sl-inputs .form-input { padding: 10px 12px; font-size: 0.85rem; }
        
        .order-summary { background: var(--bg-card); border-radius: 10px; padding: 12px; margin-bottom: 16px; }
        .summary-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.8rem; }
        .summary-row .label { color: var(--text-muted); }
        .summary-row .value { font-family: var(--font-mono); }
        
        .submit-btn { width: 100%; padding: 16px; font-size: 1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .submit-btn.buy { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .submit-btn.sell { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        
        .quick-market-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .quick-btn { padding: 10px; font-size: 0.8rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.15s; }
        .quick-btn.buy { background: rgba(34, 197, 94, 0.2); color: var(--green); border: 1px solid var(--green); }
        .quick-btn.sell { background: rgba(239, 68, 68, 0.2); color: var(--red); border: 1px solid var(--red); }
        .quick-btn:hover { transform: scale(1.02); }
        .quick-btn kbd { background: rgba(255,255,255,0.15); padding: 2px 5px; border-radius: 3px; font-size: 0.7rem; font-family: var(--font-mono); }
        
        .keyboard-hints { display: flex; justify-content: center; gap: 12px; margin-top: 12px; font-size: 0.7rem; color: var(--text-muted); }
        .keyboard-hints kbd { background: var(--bg-card); padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border); margin-right: 4px; font-family: var(--font-mono); }
        
        /* Bottom Panel - Positions & Orders */
        .bottom-panel { grid-column: 1 / -1; background: var(--bg-secondary); display: flex; flex-direction: column; }
        .bottom-tabs { display: flex; gap: 4px; padding: 8px 16px; border-bottom: 1px solid var(--border); }
        .bottom-tab { padding: 8px 16px; font-size: 0.85rem; font-weight: 500; color: var(--text-muted); cursor: pointer; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .bottom-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .bottom-tab.active { color: var(--accent); background: rgba(99, 102, 241, 0.1); }
        .bottom-tab .count { background: var(--accent); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; }
        .bottom-tab-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }
        .bottom-tab-actions .action-btn { padding: 6px 12px; font-size: 0.75rem; }
        .bottom-tab-actions .action-btn i { margin-right: 4px; }
        
        .bottom-content { flex: 1; overflow: auto; }
        .positions-table, .orders-table, .history-table { width: 100%; border-collapse: collapse; }
        .positions-table th, .orders-table th, .history-table th { padding: 10px 16px; text-align: left; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); text-transform: uppercase; background: var(--bg-card); position: sticky; top: 0; }
        .positions-table td, .orders-table td, .history-table td { padding: 12px 16px; font-size: 0.85rem; border-bottom: 1px solid var(--border); }
        .positions-table tr:hover, .orders-table tr:hover { background: var(--bg-hover); }
        
        .position-side { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .position-side.long { background: var(--green-dim); color: var(--green); }
        .position-side.short { background: var(--red-dim); color: var(--red); }
        .pnl.positive { color: var(--green); }
        .pnl.negative { color: var(--red); }
        
        .action-btn { padding: 6px 12px; font-size: 0.75rem; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .action-btn.close { background: var(--red-dim); color: var(--red); }
        .action-btn.close:hover { background: var(--red); color: white; }
        .action-btn.edit { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border); }
        .action-btn.edit:hover { border-color: var(--accent); color: var(--accent); }
        
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        .empty-state i { font-size: 2rem; margin-bottom: 10px; opacity: 0.5; }
        
        /* Loading and Error States */
        .loading-overlay { position: absolute; inset: 0; background: rgba(16,18,26,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; z-index: 10; }
        .loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .loading-overlay span { color: var(--text-muted); font-size: 0.85rem; }
        .error-state { text-align: center; padding: 30px; color: var(--text-muted); }
        .error-state i { font-size: 2rem; margin-bottom: 10px; color: var(--red); opacity: 0.7; }
        .error-state button { margin-top: 10px; padding: 6px 16px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); cursor: pointer; }
        .error-state button:hover { border-color: var(--accent); color: var(--accent); }
        .btn-loading { position: relative; pointer-events: none; opacity: 0.7; }
        .btn-loading::after { content: ''; position: absolute; width: 16px; height: 16px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; right: 10px; top: 50%; transform: translateY(-50%); }
        
        /* Symbol Search Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border-radius: 16px; width: 480px; max-height: 70vh; overflow: hidden; border: 1px solid var(--border); }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; }
        .modal-search { padding: 12px 20px; border-bottom: 1px solid var(--border); }
        .modal-search input { width: 100%; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem; }
        .modal-search input:focus { outline: none; border-color: var(--accent); }
        .symbol-list { max-height: 400px; overflow-y: auto; }
        .symbol-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; cursor: pointer; transition: background 0.15s; }
        .symbol-item:hover { background: var(--bg-hover); }
        .symbol-item-info { display: flex; align-items: center; gap: 12px; }
        .symbol-item-icon { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, var(--accent), #8b5cf6); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.7rem; }
        .symbol-item-name { font-weight: 500; }
        .symbol-item-full { font-size: 0.75rem; color: var(--text-muted); }
        .symbol-item-stats { display: flex; gap: 20px; align-items: center; }
        .symbol-item-price { text-align: right; }
        .symbol-item-price .price { font-family: var(--font-mono); font-weight: 500; }
        .symbol-item-price .change { font-size: 0.8rem; }
        .symbol-item-price .change.positive { color: var(--green); }
        .symbol-item-price .change.negative { color: var(--red); }
        .symbol-item-volume { text-align: right; min-width: 70px; }
        .symbol-item-volume .volume-label { font-size: 0.7rem; color: var(--text-muted); }
        .symbol-item-volume .volume-value { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary); }
        
        /* Exchange & Account Selector */
        .account-selector { display: flex; gap: 8px; align-items: center; }
        .exchange-select, .account-select { padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.8rem; cursor: pointer; }
        .exchange-select:focus, .account-select:focus { outline: none; border-color: var(--accent); }
        .demo-badge { background: var(--green-dim); color: var(--green); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .real-badge { background: var(--red-dim); color: var(--red); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        
        /* Analyzer Panel */
        .analyzer-panel { background: var(--bg-card); border-radius: 12px; padding: 12px; margin-bottom: 16px; border: 1px solid var(--border); }
        .analyzer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .analyzer-title { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .analyzer-title i { color: var(--accent); }
        .analyzer-controls { display: flex; gap: 8px; }
        .analyzer-btn { padding: 6px 12px; font-size: 0.75rem; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .analyzer-btn.start { background: var(--green); color: white; }
        .analyzer-btn.start:hover { background: #16a34a; }
        .analyzer-btn.stop { background: var(--red); color: white; }
        .analyzer-btn.stop:hover { background: #dc2626; }
        .analyzer-status { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
        .analyzer-status .dot { width: 6px; height: 6px; border-radius: 50%; }
        .analyzer-status .dot.running { background: var(--green); animation: pulse 1.5s infinite; }
        .analyzer-status .dot.stopped { background: var(--red); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .strategy-toggles { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .strategy-chip { padding: 4px 10px; font-size: 0.7rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 16px; cursor: pointer; transition: all 0.2s; }
        .strategy-chip:hover { border-color: var(--accent); }
        .strategy-chip.active { background: var(--accent); border-color: var(--accent); color: white; }
        
        .auto-trade-toggle { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; padding: 8px; background: var(--bg-primary); border-radius: 8px; }
        .auto-trade-toggle .toggle-switch { width: 36px; height: 20px; background: var(--bg-card); border-radius: 10px; position: relative; cursor: pointer; }
        .auto-trade-toggle .toggle-switch.active { background: var(--green); }
        .auto-trade-toggle .toggle-switch::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.2s; }
        .auto-trade-toggle .toggle-switch.active::after { transform: translateX(16px); }
        
        /* Signal Feed */
        .signal-feed { max-height: 150px; overflow-y: auto; }
        .signal-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 6px; font-size: 0.75rem; }
        .signal-item.buy { border-left: 3px solid var(--green); }
        .signal-item.sell { border-left: 3px solid var(--red); }
        .signal-info { display: flex; flex-direction: column; gap: 2px; }
        .signal-strategy { color: var(--accent); font-weight: 500; }
        .signal-reason { color: var(--text-muted); }
        .signal-confidence { font-family: var(--font-mono); }
        .signal-confidence.high { color: var(--green); }
        .signal-confidence.medium { color: var(--yellow); }
        
        @media (max-width: 1400px) {
            .terminal-layout { grid-template-columns: 260px 1fr 320px; }
        }
        @media (max-width: 1100px) {
            .terminal-layout { grid-template-columns: 1fr 300px; }
            .left-panel { display: none; }
            .ticker-tape { display: none; }
        }
        
        /* Exchange-specific styles */
        [data-exchange="hyperliquid"] .bybit-only { display: none !important; }
        [data-exchange="bybit"] .hl-only { display: none !important; }
        .hl-hidden { display: none !important; }
        
        /* Exchange badge colors */
        .exchange-select option[value="bybit"] { color: var(--bybit-color); }
        .exchange-select option[value="hyperliquid"] { color: var(--hl-color); }
        
        [data-exchange="hyperliquid"] .logo-icon { 
            background: linear-gradient(135deg, #00ff88, #00cc66); 
        }
        [data-exchange="bybit"] .logo-icon { 
            background: linear-gradient(135deg, var(--accent), #8b5cf6); 
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="terminal-layout">
        <!-- Ticker Tape -->
        <div class="ticker-tape">
            <div class="ticker-track" id="tickerTrack"></div>
        </div>
        
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <a href="/dashboard" class="logo">
                    <div class="logo-icon"><i class="fas fa-rocket"></i></div>
                    <span>ElCaro</span>
                </a>
                <div class="symbol-selector" onclick="openSymbolModal()">
                    <div class="symbol-info">
                        <span class="symbol-name" id="symbolName">BTCUSDT</span>
                        <span class="symbol-pair">Perpetual</span>
                    </div>
                    <span class="symbol-price" id="symbolPrice">$97,542.30</span>
                    <span class="symbol-change positive" id="symbolChange">+2.34%</span>
                    <i class="fas fa-chevron-down" style="color: var(--text-muted); margin-left: 8px;"></i>
                </div>
            </div>
            <div class="header-center">
                <div class="market-stat">
                    <span class="market-stat-label">24h High</span>
                    <span class="market-stat-value" id="high24h">$98,200.00</span>
                </div>
                <div class="market-stat">
                    <span class="market-stat-label">24h Low</span>
                    <span class="market-stat-value" id="low24h">$94,100.00</span>
                </div>
                <div class="market-stat">
                    <span class="market-stat-label">24h Volume</span>
                    <span class="market-stat-value" id="volume24h">$2.4B</span>
                </div>
                <div class="market-stat">
                    <span class="market-stat-label">Funding</span>
                    <span class="market-stat-value" id="fundingRate" style="color: var(--green);">+0.0100%</span>
                </div>
            </div>
            <div class="header-right">
                <div class="account-selector">
                    <select class="exchange-select" id="exchangeSelect" onchange="changeExchange()">
                        <option value="bybit">Bybit</option>
                        <option value="hyperliquid">HyperLiquid</option>
                    </select>
                    <select class="account-select" id="accountSelect" onchange="changeAccountType()">
                        <option value="demo">Demo</option>
                        <option value="real">Real</option>
                    </select>
                    <span class="demo-badge" id="accountBadge">DEMO</span>
                </div>
                <div class="ws-status">
                    <span class="ws-dot" id="wsStatus"></span>
                    <span id="wsStatusText">Connecting...</span>
                </div>
                <a href="/screener" style="color: var(--text-muted); padding: 8px;"><i class="fas fa-th"></i></a>
                <a href="/settings" style="color: var(--text-muted); padding: 8px;"><i class="fas fa-cog"></i></a>
            </div>
        </header>
        
        <!-- Left Panel - Order Book -->
        <aside class="left-panel">
            <div class="panel-tabs">
                <div class="panel-tab active" data-tab="orderbook">Order Book</div>
                <div class="panel-tab" data-tab="trades">Trades</div>
            </div>
            <div class="orderbook" id="orderbookPanel">
                <div class="orderbook-controls">
                    <div class="orderbook-grouping">
                        <button class="group-btn active" data-group="0.01">0.01</button>
                        <button class="group-btn" data-group="0.1">0.1</button>
                        <button class="group-btn" data-group="1">1</button>
                        <button class="group-btn" data-group="10">10</button>
                    </div>
                    <div class="orderbook-view-btns">
                        <button class="view-btn active" data-view="both" title="Both"><i class="fas fa-bars"></i></button>
                        <button class="view-btn" data-view="bids" title="Bids only"><i class="fas fa-arrow-up" style="color: var(--green);"></i></button>
                        <button class="view-btn" data-view="asks" title="Asks only"><i class="fas fa-arrow-down" style="color: var(--red);"></i></button>
                    </div>
                </div>
                
                <!-- Imbalance Indicator -->
                <div class="imbalance-indicator" id="imbalanceIndicator">
                    <div class="imbalance-bar">
                        <div class="imbalance-fill" style="width: 50%; background: var(--text-muted);"></div>
                    </div>
                    <span class="imbalance-label" style="color: var(--text-muted);">Neutral (0%)</span>
                </div>
                
                <div class="orderbook-header">
                    <span>Price (USDT)</span>
                    <span style="text-align: center;">Size</span>
                    <span style="text-align: right;">Total</span>
                </div>
                <div class="orderbook-asks" id="asks"></div>
                <div class="orderbook-spread">
                    <div class="spread-price up" id="lastPrice">97,542.30 <i class="fas fa-arrow-up"></i></div>
                    <div class="spread-info">
                        <span>Spread: <span id="spreadValue">$12.50</span></span>
                        <span id="spreadPercent">0.01%</span>
                    </div>
                </div>
                <div class="orderbook-bids" id="bids"></div>
            </div>
            <div class="recent-trades" id="tradesPanel">
                <div class="trades-header">
                    <span>Price</span>
                    <span style="text-align: center;">Size</span>
                    <span style="text-align: right;">Time</span>
                </div>
                <div id="tradesList"></div>
            </div>
        </aside>
        
        <!-- Chart -->
        <main class="chart-area">
            <div id="tradingview_chart"></div>
        </main>
        
        <!-- Right Panel - Order Form -->
        <aside class="right-panel">
            <div class="balance-bar">
                <div class="balance-item">
                    <span class="balance-label">Available</span>
                    <span class="balance-value" id="availableBalance">$10,000.00</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Equity</span>
                    <span class="balance-value" id="equity">$12,450.00</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Unrealized</span>
                    <span class="balance-value positive" id="unrealizedPnl">+$450.00</span>
                </div>
            </div>
            
            <div class="order-form">
                <!-- Margin Mode & Leverage -->
                <div class="margin-mode-row">
                    <div class="margin-mode-btns">
                        <button class="margin-mode-btn cross active" data-mode="cross">Cross</button>
                        <button class="margin-mode-btn" data-mode="isolated">Isolated</button>
                    </div>
                    <div class="leverage-quick" id="leverageQuick" onclick="openLeverageModal()">10x</div>
                </div>
                
                <div class="order-type-tabs">
                    <div class="order-type-tab active" data-type="limit">Limit</div>
                    <div class="order-type-tab" data-type="market">Market</div>
                    <div class="order-type-tab" data-type="stop">Stop</div>
                    <div class="order-type-tab" data-type="stopLimit">Stop Limit</div>
                </div>
                
                <div class="side-toggle">
                    <div class="side-btn buy active" data-side="buy">
                        <i class="fas fa-arrow-up"></i> Long
                    </div>
                    <div class="side-btn sell" data-side="sell">
                        <i class="fas fa-arrow-down"></i> Short
                    </div>
                </div>
                
                <!-- Advanced Options -->
                <div class="order-options">
                    <label class="order-option">
                        <input type="checkbox" id="reduceOnly"> Reduce Only
                    </label>
                    <label class="order-option">
                        <input type="checkbox" id="postOnly"> Post Only
                    </label>
                    <label class="order-option" id="tifOption">
                        <select id="tifSelect" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px; font-size: 0.7rem; color: var(--text-primary);">
                            <option value="GTC">GTC</option>
                            <option value="IOC">IOC</option>
                            <option value="FOK">FOK</option>
                        </select>
                    </label>
                </div>
                
                <div class="leverage-slider">
                    <div class="leverage-header">
                        <span class="form-label">Leverage</span>
                        <span class="leverage-value" id="leverageValue">10x</span>
                    </div>
                    <input type="range" class="slider" id="leverageSlider" min="1" max="100" value="10">
                    <div class="leverage-marks">
                        <span onclick="setLeverage(1)">1x</span>
                        <span onclick="setLeverage(5)">5x</span>
                        <span onclick="setLeverage(10)">10x</span>
                        <span onclick="setLeverage(25)">25x</span>
                        <span onclick="setLeverage(50)">50x</span>
                        <span onclick="setLeverage(100)">100x</span>
                    </div>
                </div>
                
                <div class="form-group" id="priceGroup">
                    <div class="form-label">
                        <span>Price</span>
                        <span id="markPrice">Mark: $97,540.00</span>
                    </div>
                    <div class="form-input-wrap">
                        <input type="number" class="form-input" id="priceInput" placeholder="0.00" step="0.01">
                        <span class="form-suffix">USDT</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-label">
                        <span>Size</span>
                        <span id="maxSize">Max: 0.1024 BTC</span>
                    </div>
                    <div class="form-input-wrap">
                        <input type="number" class="form-input" id="sizeInput" placeholder="0.00" step="0.001">
                        <span class="form-suffix" id="sizeSymbol">BTC</span>
                    </div>
                </div>
                
                <div class="percent-btns">
                    <div class="percent-btn" onclick="setPercent(25)">25%</div>
                    <div class="percent-btn" onclick="setPercent(50)">50%</div>
                    <div class="percent-btn" onclick="setPercent(75)">75%</div>
                    <div class="percent-btn" onclick="setPercent(100)">100%</div>
                </div>
                
                <div class="tp-sl-section">
                    <div class="tp-sl-header">
                        <div class="tp-sl-toggle">
                            <div class="toggle-switch" id="tpslToggle" onclick="toggleTPSL()"></div>
                            <span>TP/SL</span>
                        </div>
                        <div class="tp-sl-mode" id="tpslMode" style="display: none;">
                            <button class="group-btn active" data-mode="price" onclick="setTPSLMode('price')">Price</button>
                            <button class="group-btn" data-mode="percent" onclick="setTPSLMode('percent')">%</button>
                            <button class="group-btn" data-mode="roe" onclick="setTPSLMode('roe')">ROE%</button>
                        </div>
                    </div>
                    <div class="tp-sl-inputs" id="tpslInputs" style="display: none;">
                        <div>
                            <div class="form-label" style="color: var(--green);">
                                Take Profit
                                <span id="tpRoe" style="font-family: var(--font-mono);">+0%</span>
                            </div>
                            <div class="form-input-wrap">
                                <input type="number" class="form-input" id="tpInput" placeholder="0.00" oninput="calcTPSLRoe()">
                                <span class="form-suffix" id="tpSuffix">USDT</span>
                            </div>
                        </div>
                        <div>
                            <div class="form-label" style="color: var(--red);">
                                Stop Loss
                                <span id="slRoe" style="font-family: var(--font-mono);">-0%</span>
                            </div>
                            <div class="form-input-wrap">
                                <input type="number" class="form-input" id="slInput" placeholder="0.00" oninput="calcTPSLRoe()">
                                <span class="form-suffix" id="slSuffix">USDT</span>
                            </div>
                        </div>
                        <div style="grid-column: 1/-1; display: flex; gap: 4px; margin-top: 4px;">
                            <button class="percent-btn" style="flex:1; font-size: 0.65rem;" onclick="setTPPercent(2)">2%</button>
                            <button class="percent-btn" style="flex:1; font-size: 0.65rem;" onclick="setTPPercent(5)">5%</button>
                            <button class="percent-btn" style="flex:1; font-size: 0.65rem;" onclick="setTPPercent(10)">10%</button>
                            <button class="percent-btn" style="flex:1; font-size: 0.65rem;" onclick="setTPPercent(25)">25%</button>
                        </div>
                    </div>
                </div>
                
                <div class="order-summary">
                    <div class="summary-row">
                        <span class="label">Order Value</span>
                        <span class="value" id="orderValue">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Margin Required</span>
                        <span class="value" id="marginRequired">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Est. Liq. Price</span>
                        <span class="value" id="estLiqPrice">--</span>
                    </div>
                </div>
                
                <!-- Quick Market Buttons -->
                <div class="quick-market-btns">
                    <button class="quick-btn buy" onclick="quickMarket('buy')">
                        <i class="fas fa-bolt"></i> Market Buy <kbd>B</kbd>
                    </button>
                    <button class="quick-btn sell" onclick="quickMarket('sell')">
                        <i class="fas fa-bolt"></i> Market Sell <kbd>S</kbd>
                    </button>
                </div>
                
                <button class="submit-btn buy" id="submitOrder" onclick="submitOrder()">
                    <i class="fas fa-check"></i> Open Long
                </button>
                
                <div class="keyboard-hints">
                    <span><kbd>B</kbd> Buy</span>
                    <span><kbd>S</kbd> Sell</span>
                    <span><kbd>Enter</kbd> Submit</span>
                    <span><kbd>?</kbd> Help</span>
                </div>
                
                <!-- Quick Actions Bar -->
                <div class="quick-actions-bar">
                    <div class="quick-action" onclick="toggleOneClickTrading()" id="oneClickToggle" title="One-Click Trading">
                        <i class="fas fa-bolt"></i>
                        <span>1-Click</span>
                    </div>
                    <div class="quick-action" onclick="showDCABuilder()" title="DCA Ladder">
                        <i class="fas fa-layer-group"></i>
                        <span>DCA</span>
                    </div>
                    <div class="quick-action" onclick="showRiskCalc()" title="Risk Calculator">
                        <i class="fas fa-calculator"></i>
                        <span>Risk</span>
                    </div>
                    <div class="quick-action" onclick="showShortcuts()" title="Keyboard Shortcuts">
                        <i class="fas fa-keyboard"></i>
                        <span>Keys</span>
                    </div>
                </div>
            </div>
            
            <!-- Risk Calculator Panel -->
            <div class="risk-calc-panel" id="riskCalcPanel" style="display: none;">
                <div class="risk-calc-header">
                    <h4><i class="fas fa-calculator"></i> Position Sizer</h4>
                    <button class="modal-close" onclick="hideRiskCalc()"><i class="fas fa-times"></i></button>
                </div>
                <div class="risk-presets">
                    <button class="risk-preset-btn active" onclick="setRiskPreset(0.5)">0.5%</button>
                    <button class="risk-preset-btn" onclick="setRiskPreset(1)">1%</button>
                    <button class="risk-preset-btn" onclick="setRiskPreset(2)">2%</button>
                    <button class="risk-preset-btn" onclick="setRiskPreset(5)">5%</button>
                </div>
                <div class="risk-inputs">
                    <div class="form-group">
                        <div class="form-label">Risk %</div>
                        <input type="number" class="form-input" id="riskPercent" value="1" step="0.1" min="0.1" max="100">
                    </div>
                    <div class="form-group">
                        <div class="form-label">Entry Price</div>
                        <input type="number" class="form-input" id="riskEntry" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <div class="form-label" style="color: var(--red);">Stop Loss</div>
                        <input type="number" class="form-input" id="riskSL" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <div class="form-label" style="color: var(--green);">Take Profit</div>
                        <input type="number" class="form-input" id="riskTP" placeholder="0.00">
                    </div>
                </div>
                <div id="riskResult"></div>
                <button class="dca-submit" onclick="applyRiskCalc()" style="margin-top: 10px;">
                    <i class="fas fa-check"></i> Apply to Order
                </button>
            </div>
            
            <!-- DCA Builder Panel -->
            <div class="dca-builder" id="dcaPanel" style="display: none;">
                <div class="dca-header">
                    <h4><i class="fas fa-layer-group"></i> DCA Ladder</h4>
                    <button class="modal-close" onclick="hideDCABuilder()"><i class="fas fa-times"></i></button>
                </div>
                <div class="risk-inputs">
                    <div class="form-group">
                        <div class="form-label">Total Size</div>
                        <input type="number" class="form-input" id="dcaTotalSize" value="0.1" step="0.001">
                    </div>
                    <div class="form-group">
                        <div class="form-label">Orders</div>
                        <input type="number" class="form-input" id="dcaOrderCount" value="5" min="2" max="20">
                    </div>
                    <div class="form-group">
                        <div class="form-label">Range %</div>
                        <input type="number" class="form-input" id="dcaRange" value="5" step="0.5">
                    </div>
                    <div class="form-group">
                        <div class="form-label">Distribution</div>
                        <select class="form-input" id="dcaDistribution" style="padding-right: 10px;">
                            <option value="linear">Linear</option>
                            <option value="geometric">Geometric</option>
                            <option value="fibonacci">Fibonacci</option>
                            <option value="exponential">Exponential</option>
                        </select>
                    </div>
                </div>
                <div class="dca-summary" id="dcaSummary"></div>
                <div class="dca-orders" id="dcaOrdersList"></div>
                <button class="dca-submit" onclick="placeDCALadder()">
                    <i class="fas fa-bolt"></i> Place DCA Orders
                </button>
            </div>
            
            <!-- Alerts Panel -->
            <div class="alerts-panel" id="alertsPanel">
                <div class="alerts-header">
                    <h4><i class="fas fa-bell"></i> Price Alerts</h4>
                    <button class="add-alert-btn" onclick="SmartAlerts.showAddModal()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="alerts-list" id="alertsList">
                    <p class="empty">No active alerts</p>
                </div>
            </div>
        </aside>
        
        <!-- Bottom Panel - Positions -->
        <section class="bottom-panel">
            <div class="bottom-tabs">
                <div class="bottom-tab active" data-panel="positions">
                    <i class="fas fa-layer-group"></i> Positions
                    <span class="count" id="positionsCount">0</span>
                </div>
                <div class="bottom-tab" data-panel="orders">
                    <i class="fas fa-clock"></i> Open Orders
                    <span class="count" id="ordersCount">0</span>
                </div>
                <div class="bottom-tab" data-panel="history">
                    <i class="fas fa-history"></i> Trade History
                </div>
                <div class="bottom-tab-actions">
                    <button class="action-btn close" onclick="closeAllPositions()" title="Close All Positions">
                        <i class="fas fa-times-circle"></i> Close All
                    </button>
                    <button class="action-btn edit" onclick="cancelAllOrders()" title="Cancel All Orders">
                        <i class="fas fa-ban"></i> Cancel All
                    </button>
                    <button class="action-btn" onclick="loadPositions(); loadOrders(); loadBalance();" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="bottom-content">
                <div id="positionsPanel">
                    <table class="positions-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Size</th>
                                <th>Entry Price</th>
                                <th>Mark Price</th>
                                <th>Liq. Price</th>
                                <th>Margin</th>
                                <th>PnL (ROE%)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="positionsBody">
                            <tr><td colspan="9" class="empty-state"><i class="fas fa-inbox"></i><p>No open positions</p></td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="ordersPanel" style="display: none;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Size</th>
                                <th>Filled</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody">
                            <tr><td colspan="8" class="empty-state"><i class="fas fa-clock"></i><p>No open orders</p></td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="historyPanel" style="display: none;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Size</th>
                                <th>Fee</th>
                                <th>PnL</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Symbol Search Modal -->
    <div class="modal-overlay" id="symbolModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Select Symbol</span>
                <button class="modal-close" onclick="closeSymbolModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-search">
                <input type="text" id="symbolSearch" placeholder="Search symbol..." oninput="filterSymbols()">
            </div>
            <div class="symbol-list" id="symbolList"></div>
        </div>
    </div>
    
    <script>
        // State
        const state = {
            symbol: 'BTCUSDT',
            side: 'buy',
            orderType: 'limit',
            leverage: 10,
            price: 0,
            size: 0,
            tpslEnabled: false,
            exchange: 'bybit',
            accountType: 'demo',
            ws: null,
            settingsWs: null,
            positions: [],
            orders: [],
            orderbookGroup: 0.01,
            orderbookView: 'both',
            recentTrades: [],
            lastPrice: 97542.30,
            marginMode: 'cross',
            // Loading states
            loading: {
                positions: false,
                orders: false,
                balance: false,
                symbols: false,
                order: false
            },
            // Error states
            errors: {
                positions: null,
                orders: null,
                balance: null,
                symbols: null
            }
        };
        
        // Loading overlay helper
        function setLoading(element, isLoading, message = 'Loading...') {
            const container = typeof element === 'string' ? document.getElementById(element) : element;
            if (!container) return;
            
            const existingOverlay = container.querySelector('.loading-overlay');
            if (isLoading && !existingOverlay) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = `<div class="loading-spinner"></div><span>${message}</span>`;
                container.style.position = 'relative';
                container.appendChild(overlay);
            } else if (!isLoading && existingOverlay) {
                existingOverlay.remove();
            }
        }
        
        // Show error in table
        function showTableError(tbodyId, colspan, message) {
            const tbody = document.getElementById(tbodyId);
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="error-state"><i class="fas fa-exclamation-triangle"></i><p>${message}</p><button class="btn btn-sm btn-secondary" onclick="location.reload()">Retry</button></td></tr>`;
            }
        }
        
        const symbols = [
            { symbol: 'BTCUSDT', name: 'Bitcoin', price: 97542.30, change: 2.34 },
            { symbol: 'ETHUSDT', name: 'Ethereum', price: 3456.78, change: 1.56 },
            { symbol: 'SOLUSDT', name: 'Solana', price: 189.45, change: -0.89 },
            { symbol: 'BNBUSDT', name: 'BNB', price: 678.90, change: 0.45 },
            { symbol: 'XRPUSDT', name: 'XRP', price: 2.34, change: 3.21 },
            { symbol: 'DOGEUSDT', name: 'Dogecoin', price: 0.3456, change: -1.23 },
            { symbol: 'ADAUSDT', name: 'Cardano', price: 0.89, change: 2.10 },
            { symbol: 'AVAXUSDT', name: 'Avalanche', price: 42.56, change: 4.56 },
            { symbol: 'LINKUSDT', name: 'Chainlink', price: 23.45, change: -0.67 },
            { symbol: 'DOTUSDT', name: 'Polkadot', price: 7.89, change: 1.23 }
        ];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTickerTape();
            initTradingView();
            initEventListeners();
            initOrderbook();
            loadPositions();
            loadOrders();
            loadBalance();
            connectWebSocket();
            renderSymbolList();
            
            // Auto-refresh data every 10 seconds
            setInterval(() => {
                loadPositions();
                loadOrders();
                loadBalance();
            }, 10000);
        });
        
        function initTickerTape() {
            const track = document.getElementById('tickerTrack');
            const tickerData = [
                { symbol: 'BTC', price: 97542.30, change: 2.34 },
                { symbol: 'ETH', price: 3456.78, change: 1.56 },
                { symbol: 'SOL', price: 189.45, change: -0.89 },
                { symbol: 'BNB', price: 678.90, change: 0.45 },
                { symbol: 'XRP', price: 2.34, change: 3.21 },
                { symbol: 'DOGE', price: 0.3456, change: -1.23 },
                { symbol: 'ADA', price: 0.89, change: 2.10 },
                { symbol: 'AVAX', price: 42.56, change: 4.56 },
                { symbol: 'LINK', price: 23.45, change: -0.67 },
                { symbol: 'DOT', price: 7.89, change: 1.23 },
                { symbol: 'MATIC', price: 0.78, change: -2.15 },
                { symbol: 'UNI', price: 12.34, change: 3.45 },
                { symbol: 'ATOM', price: 8.90, change: 1.78 },
                { symbol: 'LTC', price: 102.50, change: 0.89 },
                { symbol: 'FIL', price: 5.67, change: -1.34 },
            ];
            
            // Create items twice for seamless loop
            const html = [...tickerData, ...tickerData].map(t => `
                <div class="ticker-item" onclick="selectSymbol('${t.symbol}USDT')">
                    <span class="ticker-symbol">${t.symbol}/USDT</span>
                    <span class="ticker-price">$${t.price.toLocaleString()}</span>
                    <span class="ticker-change ${t.change >= 0 ? 'up' : 'down'}">${t.change >= 0 ? '+' : ''}${t.change.toFixed(2)}%</span>
                </div>
            `).join('');
            track.innerHTML = html;
        }
        
        function initTradingView() {
            if (typeof TradingView === 'undefined') return;
            new TradingView.widget({
                container_id: "tradingview_chart",
                autosize: true,
                symbol: "BINANCE:" + state.symbol,
                interval: "15",
                timezone: "Etc/UTC",
                theme: "dark",
                style: "1",
                locale: "en",
                toolbar_bg: "#0a0a0f",
                enable_publishing: false,
                hide_side_toolbar: false,
                allow_symbol_change: true,
                studies: ["RSI@tv-basicstudies", "MACD@tv-basicstudies"],
                backgroundColor: "#0a0a0f",
                gridColor: "rgba(255,255,255,0.03)"
            });
        }
        
        function initEventListeners() {
            // Order type tabs
            document.querySelectorAll('.order-type-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.order-type-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.orderType = tab.dataset.type;
                    document.getElementById('priceGroup').style.display = state.orderType === 'market' ? 'none' : 'block';
                });
            });
            
            // Side toggle
            document.querySelectorAll('.side-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setSide(btn.dataset.side);
                });
            });
            
            // Margin mode buttons
            document.querySelectorAll('.margin-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setMarginMode(btn.dataset.mode);
                });
            });
            
            // Leverage slider
            document.getElementById('leverageSlider').addEventListener('input', (e) => {
                state.leverage = parseInt(e.target.value);
                document.getElementById('leverageValue').textContent = state.leverage + 'x';
                updateOrderSummary();
            });
            
            // Price & Size inputs
            document.getElementById('priceInput').addEventListener('input', updateOrderSummary);
            document.getElementById('sizeInput').addEventListener('input', updateOrderSummary);
            
            // Panel tabs
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('orderbookPanel').style.display = tab.dataset.tab === 'orderbook' ? 'flex' : 'none';
                    document.getElementById('tradesPanel').classList.toggle('active', tab.dataset.tab === 'trades');
                });
            });
            
            // Orderbook grouping buttons
            document.querySelectorAll('.group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.group-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.orderbookGroup = parseFloat(btn.dataset.group);
                    initOrderbook();
                });
            });
            
            // Orderbook view buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.orderbookView = btn.dataset.view;
                    updateOrderbookView();
                });
            });
            
            // Bottom tabs
            document.querySelectorAll('.bottom-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.bottom-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('positionsPanel').style.display = tab.dataset.panel === 'positions' ? 'block' : 'none';
                    document.getElementById('ordersPanel').style.display = tab.dataset.panel === 'orders' ? 'block' : 'none';
                    document.getElementById('historyPanel').style.display = tab.dataset.panel === 'history' ? 'block' : 'none';
                });
            });
        }
        
        function updateOrderbookView() {
            const asks = document.getElementById('asks');
            const bids = document.getElementById('bids');
            if (state.orderbookView === 'bids') {
                asks.style.display = 'none';
                bids.style.display = 'flex';
                bids.style.flex = '1';
            } else if (state.orderbookView === 'asks') {
                asks.style.display = 'flex';
                asks.style.flex = '1';
                bids.style.display = 'none';
            } else {
                asks.style.display = 'flex';
                asks.style.flex = '1';
                bids.style.display = 'flex';
                bids.style.flex = '1';
            }
        }
        
        function setLeverage(val) {
            state.leverage = val;
            document.getElementById('leverageSlider').value = val;
            document.getElementById('leverageValue').textContent = val + 'x';
            updateOrderSummary();
        }
        
        function setPercent(pct) {
            const available = parseFloat(document.getElementById('availableBalance').textContent.replace(/[$,]/g, ''));
            const price = parseFloat(document.getElementById('priceInput').value) || parseFloat(document.getElementById('symbolPrice').textContent.replace(/[$,]/g, ''));
            if (price > 0) {
                const maxSize = (available * state.leverage * (pct / 100)) / price;
                document.getElementById('sizeInput').value = maxSize.toFixed(4);
                updateOrderSummary();
            }
        }
        
        function toggleTPSL() {
            state.tpslEnabled = !state.tpslEnabled;
            document.getElementById('tpslToggle').classList.toggle('active', state.tpslEnabled);
            document.getElementById('tpslInputs').style.display = state.tpslEnabled ? 'grid' : 'none';
            document.getElementById('tpslMode').style.display = state.tpslEnabled ? 'flex' : 'none';
        }
        
        // TP/SL mode (price, percent, roe)
        let tpslMode = 'price';
        function setTPSLMode(mode) {
            tpslMode = mode;
            document.querySelectorAll('#tpslMode .group-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.mode === mode);
            });
            const tpSuffix = document.getElementById('tpSuffix');
            const slSuffix = document.getElementById('slSuffix');
            if (mode === 'price') {
                tpSuffix.textContent = 'USDT';
                slSuffix.textContent = 'USDT';
            } else {
                tpSuffix.textContent = '%';
                slSuffix.textContent = '%';
            }
            calcTPSLRoe();
        }
        
        function calcTPSLRoe() {
            const entryPrice = parseFloat(document.getElementById('priceInput').value) || 0;
            const tpVal = parseFloat(document.getElementById('tpInput').value) || 0;
            const slVal = parseFloat(document.getElementById('slInput').value) || 0;
            const leverage = state.leverage || 1;
            const isBuy = state.side === 'buy';
            let tpRoe = 0, slRoe = 0;
            
            if (entryPrice > 0 && tpVal > 0) {
                if (tpslMode === 'price') {
                    const priceDiff = isBuy ? tpVal - entryPrice : entryPrice - tpVal;
                    tpRoe = (priceDiff / entryPrice) * 100 * leverage;
                } else if (tpslMode === 'percent') {
                    tpRoe = tpVal * leverage;
                } else {
                    tpRoe = tpVal;
                }
            }
            
            if (entryPrice > 0 && slVal > 0) {
                if (tpslMode === 'price') {
                    const priceDiff = isBuy ? entryPrice - slVal : slVal - entryPrice;
                    slRoe = (priceDiff / entryPrice) * 100 * leverage;
                } else if (tpslMode === 'percent') {
                    slRoe = slVal * leverage;
                } else {
                    slRoe = slVal;
                }
            }
            
            document.getElementById('tpRoe').textContent = tpRoe > 0 ? '+' + tpRoe.toFixed(1) + '%' : '+0%';
            document.getElementById('slRoe').textContent = slRoe > 0 ? '-' + slRoe.toFixed(1) + '%' : '-0%';
        }
        
        function setTPPercent(pct) {
            const entryPrice = parseFloat(document.getElementById('priceInput').value) || 0;
            if (entryPrice <= 0) return;
            const isBuy = state.side === 'buy';
            
            if (tpslMode === 'price') {
                const tpPrice = isBuy ? entryPrice * (1 + pct/100) : entryPrice * (1 - pct/100);
                const slPrice = isBuy ? entryPrice * (1 - pct/100) : entryPrice * (1 + pct/100);
                document.getElementById('tpInput').value = tpPrice.toFixed(2);
                document.getElementById('slInput').value = slPrice.toFixed(2);
            } else {
                document.getElementById('tpInput').value = pct;
                document.getElementById('slInput').value = pct;
            }
            calcTPSLRoe();
        }
        
        function setSide(side) {
            state.side = side;
            document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.side-btn.${side}`)?.classList.add('active');
            updateSubmitButton();
            calcTPSLRoe();
        }
        
        function setOrderType(type) {
            state.orderType = type;
            document.querySelectorAll('.order-type-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.order-type-tab[data-type="${type}"]`)?.classList.add('active');
            document.getElementById('priceGroup').style.display = type === 'market' ? 'none' : 'block';
            if (type === 'market') {
                document.getElementById('priceInput').value = state.lastPrice || '';
            }
        }
        
        function setMarginMode(mode) {
            state.marginMode = mode;
            document.querySelectorAll('.margin-mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.margin-mode-btn[data-mode="${mode}"]`)?.classList.add('active');
        }
        
        function openLeverageModal() {
            const lev = prompt('Enter leverage (1-100):', state.leverage);
            if (lev && !isNaN(lev) && lev >= 1 && lev <= 100) {
                setLeverage(parseInt(lev));
                document.getElementById('leverageQuick').textContent = state.leverage + 'x';
            }
        }
        
        function updateSubmitButton() {
            const btn = document.getElementById('submitOrder');
            btn.className = 'submit-btn ' + state.side;
            btn.innerHTML = state.side === 'buy' 
                ? '<i class="fas fa-arrow-up"></i> Open Long' 
                : '<i class="fas fa-arrow-down"></i> Open Short';
        }
        
        function updateOrderSummary() {
            const price = parseFloat(document.getElementById('priceInput').value) || 0;
            const size = parseFloat(document.getElementById('sizeInput').value) || 0;
            const orderValue = price * size;
            const margin = orderValue / state.leverage;
            
            document.getElementById('orderValue').textContent = '$' + orderValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('marginRequired').textContent = '$' + margin.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            if (price > 0 && size > 0) {
                const liqPrice = state.side === 'buy' 
                    ? price * (1 - 1/state.leverage * 0.9)
                    : price * (1 + 1/state.leverage * 0.9);
                document.getElementById('estLiqPrice').textContent = '$' + liqPrice.toFixed(2);
            }
        }
        
        function initOrderbook() {
            const asks = document.getElementById('asks');
            const bids = document.getElementById('bids');
            const basePrice = 97542.30;
            const grouping = state.orderbookGroup;
            
            // Generate mock orderbook with grouping
            const askLevels = [], bidLevels = [];
            let totalAskSize = 0, totalBidSize = 0;
            
            for (let i = 15; i >= 1; i--) {
                const price = Math.ceil((basePrice + i * 3 * grouping) / grouping) * grouping;
                const size = Math.random() * 3 + 0.1;
                totalAskSize += size;
                askLevels.push({ price, size, total: totalAskSize });
            }
            for (let i = 1; i <= 15; i++) {
                const price = Math.floor((basePrice - i * 3 * grouping) / grouping) * grouping;
                const size = Math.random() * 3 + 0.1;
                totalBidSize += size;
                bidLevels.push({ price, size, total: totalBidSize });
            }
            
            const maxAskTotal = totalAskSize;
            const maxBidTotal = totalBidSize;
            
            asks.innerHTML = askLevels.reverse().map(l => {
                const depth = (l.total / maxAskTotal) * 100;
                const priceStr = l.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                return `<div class="orderbook-row ask" onclick="setPrice(${l.price})">
                    <span class="price">${priceStr}</span>
                    <span class="size">${l.size.toFixed(4)}</span>
                    <span class="total">${l.total.toFixed(2)}</span>
                    <div class="depth" style="width: ${depth}%"></div>
                </div>`;
            }).join('');
            
            bids.innerHTML = bidLevels.map(l => {
                const depth = (l.total / maxBidTotal) * 100;
                const priceStr = l.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                return `<div class="orderbook-row bid" onclick="setPrice(${l.price})">
                    <span class="price">${priceStr}</span>
                    <span class="size">${l.size.toFixed(4)}</span>
                    <span class="total">${l.total.toFixed(2)}</span>
                    <div class="depth" style="width: ${depth}%"></div>
                </div>`;
            }).join('');
            
            // Update spread
            const spread = askLevels[askLevels.length - 1].price - bidLevels[0].price;
            const spreadPct = (spread / basePrice * 100).toFixed(4);
            document.getElementById('spreadValue').textContent = '$' + spread.toFixed(2);
            document.getElementById('spreadPercent').textContent = spreadPct + '%';
            
            // Init recent trades
            initRecentTrades();
        }
        
        function initRecentTrades() {
            const trades = [];
            const basePrice = 97542.30;
            for (let i = 0; i < 30; i++) {
                const isBuy = Math.random() > 0.5;
                const price = basePrice + (Math.random() - 0.5) * 20;
                const size = Math.random() * 0.5 + 0.01;
                const time = new Date(Date.now() - i * 2000);
                trades.push({ isBuy, price, size, time });
            }
            state.recentTrades = trades;
            renderRecentTrades();
        }
        
        function renderRecentTrades() {
            const list = document.getElementById('tradesList');
            list.innerHTML = state.recentTrades.slice(0, 25).map(t => `
                <div class="trade-row ${t.isBuy ? 'buy' : 'sell'}">
                    <span class="price">${t.price.toFixed(2)}</span>
                    <span style="text-align: center;">${t.size.toFixed(4)}</span>
                    <span class="time">${t.time.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit'})}</span>
                </div>
            `).join('');
        }
        
        function setPrice(price) {
            document.getElementById('priceInput').value = price;
            updateOrderSummary();
        }
        
        function connectWebSocket() {
            const wsStatus = document.getElementById('wsStatus');
            const wsText = document.getElementById('wsStatusText');
            
            try {
                const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                state.ws = new WebSocket(`${proto}//${location.host}/ws/terminal`);
                
                state.ws.onopen = () => {
                    wsStatus.classList.add('connected');
                    wsText.textContent = 'Live';
                };
                
                state.ws.onclose = () => {
                    wsStatus.classList.remove('connected');
                    wsText.textContent = 'Reconnecting...';
                    setTimeout(connectWebSocket, 3000);
                };
                
                state.ws.onerror = () => state.ws.close();
                
                state.ws.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    handleWSMessage(data);
                };
            } catch (e) {
                wsText.textContent = 'Offline';
            }
        }
        
        function handleWSMessage(data) {
            if (data.type === 'ticker') {
                state.lastPrice = data.price;
                document.getElementById('symbolPrice').textContent = '$' + data.price.toLocaleString();
                document.getElementById('symbolChange').textContent = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + '%';
                document.getElementById('symbolChange').className = 'symbol-change ' + (data.change >= 0 ? 'positive' : 'negative');
                // Update last price indicator
                const lastPriceEl = document.getElementById('lastPrice');
                if (lastPriceEl) {
                    lastPriceEl.textContent = data.price.toLocaleString(undefined, {minimumFractionDigits: 2});
                }
            } else if (data.type === 'positions') {
                renderPositions(data.data);
            } else if (data.type === 'orders') {
                renderOrders(data.data);
            } else if (data.type === 'balance') {
                document.getElementById('availableBalance').textContent = '$' + data.available.toLocaleString();
                document.getElementById('equity').textContent = '$' + data.equity.toLocaleString();
            }
        }
        
        async function loadPositions() {
            const posTable = document.querySelector('.positions-table');
            try {
                state.loading.positions = true;
                state.errors.positions = null;
                setLoading(posTable, true, 'Loading positions...');
                
                const token = localStorage.getItem('elcaro_token');
                if (!token) {
                    showTableError('positionsBody', 9, 'Please log in to view positions');
                    return;
                }
                
                const params = new URLSearchParams({
                    exchange: state.exchange || 'bybit',
                    account_type: state.accountType || 'demo'
                });
                
                const res = await fetch(`/api/trading/positions?${params}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!res.ok) {
                    const error = await res.json().catch(() => ({ detail: 'Failed to load positions' }));
                    throw new Error(error.detail || `Error ${res.status}`);
                }
                
                const data = await res.json();
                state.positions = data;
                renderPositions(data);
            } catch (e) {
                console.error('loadPositions error:', e);
                state.errors.positions = e.message;
                showTableError('positionsBody', 9, e.message);
            } finally {
                state.loading.positions = false;
                setLoading(posTable, false);
            }
        }
        
        async function loadOrders() {
            const ordersTable = document.querySelector('.orders-table');
            try {
                state.loading.orders = true;
                state.errors.orders = null;
                setLoading(ordersTable, true, 'Loading orders...');
                
                const token = localStorage.getItem('elcaro_token');
                if (!token) {
                    showTableError('ordersBody', 8, 'Please log in to view orders');
                    return;
                }
                
                const params = new URLSearchParams({
                    exchange: state.exchange || 'bybit',
                    account_type: state.accountType || 'demo'
                });
                
                const res = await fetch(`/api/trading/orders?${params}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!res.ok) {
                    const error = await res.json().catch(() => ({ detail: 'Failed to load orders' }));
                    throw new Error(error.detail || `Error ${res.status}`);
                }
                
                const data = await res.json();
                state.orders = data;
                renderOrders(data);
            } catch (e) {
                console.error('loadOrders error:', e);
                state.errors.orders = e.message;
                showTableError('ordersBody', 8, e.message);
            } finally {
                state.loading.orders = false;
                setLoading(ordersTable, false);
            }
        }
        
        async function loadBalance() {
            const balanceCard = document.querySelector('.balance-display');
            try {
                state.loading.balance = true;
                
                const token = localStorage.getItem('elcaro_token');
                if (!token) return;
                
                const params = new URLSearchParams({
                    exchange: state.exchange || 'bybit',
                    account_type: state.accountType || 'demo'
                });
                
                const res = await fetch(`/api/trading/balance?${params}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (!res.ok) {
                    throw new Error('Failed to load balance');
                }
                
                const data = await res.json();
                document.getElementById('availableBalance').textContent = '$' + (data.available || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('equity').textContent = '$' + (data.equity || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                const pnl = data.unrealized_pnl || 0;
                const pnlEl = document.getElementById('unrealizedPnl');
                pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                pnlEl.className = 'balance-value ' + (pnl >= 0 ? 'positive' : 'negative');
            } catch (e) {
                console.error('loadBalance error:', e);
                // Show error in balance display
                document.getElementById('availableBalance').textContent = '--';
                document.getElementById('equity').textContent = '--';
                document.getElementById('unrealizedPnl').textContent = '--';
            } finally {
                state.loading.balance = false;
            }
        }
        
        function renderPositions(positions) {
            const tbody = document.getElementById('positionsBody');
            document.getElementById('positionsCount').textContent = positions.length;
            
            if (!positions.length) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><i class="fas fa-inbox"></i><p>No open positions</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = positions.map(p => {
                const pnlClass = p.pnl >= 0 ? 'positive' : 'negative';
                return `<tr>
                    <td><strong>${p.symbol}</strong></td>
                    <td><span class="position-side ${p.side}">${p.side.toUpperCase()}</span></td>
                    <td style="font-family: var(--font-mono);">${p.size}</td>
                    <td style="font-family: var(--font-mono);">$${p.entry_price.toLocaleString()}</td>
                    <td style="font-family: var(--font-mono);">$${p.mark_price.toLocaleString()}</td>
                    <td style="font-family: var(--font-mono); color: var(--red);">$${p.liq_price?.toLocaleString() || '--'}</td>
                    <td style="font-family: var(--font-mono);">$${p.margin?.toLocaleString() || '--'}</td>
                    <td class="pnl ${pnlClass}" style="font-family: var(--font-mono);">${p.pnl >= 0 ? '+' : ''}$${p.pnl.toFixed(2)} (${p.roe >= 0 ? '+' : ''}${p.roe?.toFixed(2) || 0}%)</td>
                    <td>
                        <button class="action-btn close" onclick="closePosition('${p.symbol}')">Close</button>
                        <button class="action-btn edit" onclick="editPosition('${p.symbol}')">TP/SL</button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function renderOrders(orders) {
            const tbody = document.getElementById('ordersBody');
            document.getElementById('ordersCount').textContent = orders.length;
            
            if (!orders.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fas fa-clock"></i><p>No open orders</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(o => `<tr>
                <td>${new Date(o.time).toLocaleTimeString()}</td>
                <td><strong>${o.symbol}</strong></td>
                <td>${o.type}</td>
                <td><span class="position-side ${o.side}">${o.side.toUpperCase()}</span></td>
                <td style="font-family: var(--font-mono);">$${parseFloat(o.price || 0).toLocaleString()}</td>
                <td style="font-family: var(--font-mono);">${o.size}</td>
                <td>${o.filled || 0}%</td>
                <td><button class="action-btn close" onclick="cancelOrder('${o.id}', '${o.symbol}')">Cancel</button></td>
            </tr>`).join('');
        }
        
        // Quick market order with hotkey support
        function quickMarket(side) {
            state.side = side;
            state.orderType = 'market';
            updateSubmitButton();
            // Update order type UI
            document.querySelectorAll('.order-type-tab').forEach(b => {
                b.classList.toggle('active', b.dataset.type === 'market');
            });
            document.getElementById('priceGroup').style.display = 'none';
            // Set market price from current symbol price
            const currentPrice = parseFloat(document.getElementById('symbolPrice').textContent.replace(/[$,]/g, ''));
            state.lastPrice = currentPrice;
            document.getElementById('priceInput').value = currentPrice || '';
            submitOrder();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }
            
            switch(e.key.toLowerCase()) {
                case 'b':
                    e.preventDefault();
                    setSide('buy');
                    break;
                case 's':
                    e.preventDefault();
                    setSide('sell');
                    break;
                case 'enter':
                    e.preventDefault();
                    submitOrder();
                    break;
                case 'escape':
                    document.getElementById('sizeInput').value = '';
                    document.getElementById('priceInput').value = '';
                    break;
                case '1':
                    e.preventDefault();
                    setOrderType('limit');
                    break;
                case '2':
                    e.preventDefault();
                    setOrderType('market');
                    break;
                case '3':
                    e.preventDefault();
                    setOrderType('conditional');
                    break;
            }
        });
        
        async function submitOrder() {
            const submitBtn = document.querySelector('.submit-btn');
            const price = parseFloat(document.getElementById('priceInput').value);
            const size = parseFloat(document.getElementById('sizeInput').value);
            
            // Validation
            const errors = [];
            if (!size || size <= 0) {
                errors.push('Enter valid order size');
            }
            if (state.orderType !== 'market' && (!price || price <= 0)) {
                errors.push('Enter valid price for limit order');
            }
            if (!state.symbol) {
                errors.push('Select a trading pair');
            }
            if (!localStorage.getItem('elcaro_token')) {
                showNotification('Please log in to trade', 'error');
                return;
            }
            
            if (errors.length > 0) {
                errors.forEach(e => showNotification(e, 'warning'));
                return;
            }
            
            // Get TP/SL values based on mode
            let tp = null, sl = null;
            if (state.tpslEnabled) {
                const tpVal = parseFloat(document.getElementById('tpInput').value);
                const slVal = parseFloat(document.getElementById('slInput').value);
                const entryPrice = state.orderType === 'market' ? state.lastPrice : price;
                
                if (tpslMode === 'price') {
                    tp = tpVal || null;
                    sl = slVal || null;
                } else if (tpslMode === 'percent') {
                    const isBuy = state.side === 'buy';
                    if (tpVal) tp = isBuy ? entryPrice * (1 + tpVal/100) : entryPrice * (1 - tpVal/100);
                    if (slVal) sl = isBuy ? entryPrice * (1 - slVal/100) : entryPrice * (1 + slVal/100);
                } else { // ROE mode
                    const isBuy = state.side === 'buy';
                    if (tpVal) {
                        const tpPct = tpVal / state.leverage;
                        tp = isBuy ? entryPrice * (1 + tpPct/100) : entryPrice * (1 - tpPct/100);
                    }
                    if (slVal) {
                        const slPct = slVal / state.leverage;
                        sl = isBuy ? entryPrice * (1 - slPct/100) : entryPrice * (1 + slPct/100);
                    }
                }
                
                // Validate TP/SL logic
                if (tp && sl) {
                    const isBuy = state.side === 'buy';
                    const entryPrice = state.orderType === 'market' ? state.lastPrice : price;
                    if (isBuy && (tp <= entryPrice || sl >= entryPrice)) {
                        showNotification('For LONG: TP must be above entry, SL below', 'warning');
                    } else if (!isBuy && (tp >= entryPrice || sl <= entryPrice)) {
                        showNotification('For SHORT: TP must be below entry, SL above', 'warning');
                    }
                }
            }
            
            const order = {
                symbol: state.symbol,
                side: state.side,
                type: state.orderType,
                price: state.orderType === 'market' ? null : price,
                size: size,
                leverage: state.leverage,
                tp: tp,
                sl: sl,
                exchange: state.exchange || 'bybit',
                account_type: state.accountType || 'demo',
                reduceOnly: document.getElementById('reduceOnly')?.checked || false,
                postOnly: document.getElementById('postOnly')?.checked || false,
                timeInForce: document.getElementById('tifSelect')?.value || 'GTC'
            };
            
            try {
                state.loading.order = true;
                if (submitBtn) submitBtn.classList.add('btn-loading');
                
                const token = localStorage.getItem('elcaro_token');
                const res = await fetch('/api/trading/order', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify(order)
                });
                
                const data = await res.json();
                if (data.success || res.ok) {
                    showNotification(`${state.side.toUpperCase()} ${state.symbol} order placed!`, 'success');
                    document.getElementById('sizeInput').value = '';
                    loadPositions();
                    loadOrders();
                } else {
                    showNotification(data.error || data.detail || 'Order failed', 'error');
                }
            } catch (e) {
                console.error('Order error:', e);
                showNotification('Failed to place order: ' + e.message, 'error');
            } finally {
                state.loading.order = false;
                if (submitBtn) submitBtn.classList.remove('btn-loading');
            }
        }
        
        async function closePosition(symbol) {
            if (!confirm(`Close position for ${symbol}?`)) return;
            
            try {
                const token = localStorage.getItem('elcaro_token');
                const res = await fetch('/api/trading/close', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ 
                        symbol,
                        exchange: state.exchange || 'bybit',
                        account_type: state.accountType || 'demo'
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showNotification('Position closed', 'success');
                    loadPositions();
                } else {
                    showNotification(data.error || 'Failed to close', 'error');
                }
            } catch (e) {
                showNotification('Error closing position', 'error');
            }
        }
        
        async function editPosition(symbol) {
            const tp = prompt('Enter Take Profit price (leave empty to skip):');
            const sl = prompt('Enter Stop Loss price (leave empty to skip):');
            
            if (!tp && !sl) return;
            
            try {
                const token = localStorage.getItem('elcaro_token');
                const res = await fetch('/api/trading/modify-tpsl', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ 
                        symbol,
                        take_profit: tp ? parseFloat(tp) : null,
                        stop_loss: sl ? parseFloat(sl) : null,
                        exchange: state.exchange || 'bybit',
                        account_type: state.accountType || 'demo'
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showNotification('TP/SL updated', 'success');
                    loadPositions();
                } else {
                    showNotification(data.error || 'Failed to update TP/SL', 'error');
                }
            } catch (e) {
                showNotification('Error updating TP/SL', 'error');
            }
        }
        
        async function cancelOrder(orderId, symbol) {
            if (!confirm('Cancel this order?')) return;
            
            try {
                const token = localStorage.getItem('elcaro_token');
                const res = await fetch('/api/trading/order', {
                    method: 'DELETE',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ 
                        symbol: symbol,
                        order_id: orderId,
                        exchange: state.exchange || 'bybit',
                        account_type: state.accountType || 'demo'
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showNotification('Order cancelled', 'success');
                    loadOrders();
                } else {
                    showNotification(data.error || 'Failed to cancel order', 'error');
                }
            } catch (e) {
                showNotification('Error cancelling order', 'error');
            }
        }
        
        async function closeAllPositions() {
            const count = state.positions?.length || 0;
            if (count === 0) {
                showNotification('No open positions', 'info');
                return;
            }
            if (!confirm(`Close ALL ${count} positions? This action cannot be undone.`)) return;
            
            try {
                const token = localStorage.getItem('elcaro_token');
                const res = await fetch('/api/trading/close-all', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({
                        exchange: state.exchange || 'bybit',
                        account_type: state.accountType || 'demo'
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showNotification(`Closed ${data.closed || count} positions`, 'success');
                    loadPositions();
                    loadBalance();
                } else {
                    showNotification(data.error || 'Failed to close all positions', 'error');
                }
            } catch (e) {
                showNotification('Error closing positions', 'error');
            }
        }
        
        async function cancelAllOrders() {
            const count = state.orders?.length || 0;
            if (count === 0) {
                showNotification('No open orders', 'info');
                return;
            }
            if (!confirm(`Cancel ALL ${count} orders?`)) return;
            
            try {
                const token = localStorage.getItem('elcaro_token');
                const params = new URLSearchParams({
                    exchange: state.exchange || 'bybit',
                    account_type: state.accountType || 'demo'
                });
                
                const res = await fetch(`/api/trading/cancel-all-orders?${params}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + token 
                    }
                });
                
                const data = await res.json();
                if (data.success) {
                    showNotification(`Cancelled ${data.cancelled || count} orders`, 'success');
                    loadOrders();
                } else {
                    showNotification(data.error || 'Failed to cancel orders', 'error');
                }
            } catch (e) {
                showNotification('Error cancelling orders', 'error');
            }
        }
        
        // Notification system with stacking
        const notifications = [];
        function showNotification(msg, type = 'info', duration = 3500) {
            // Create container if not exists
            let container = document.getElementById('notificationContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notificationContainer';
                container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
                document.body.appendChild(container);
            }
            
            const n = document.createElement('div');
            const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            const colors = { success: 'var(--green)', error: 'var(--red)', warning: '#f59e0b', info: 'var(--accent)' };
            
            n.className = 'notification notification-' + type;
            n.style.cssText = `padding: 14px 20px; border-radius: 12px; background: ${colors[type] || colors.info}; 
                color: white; font-weight: 500; box-shadow: 0 8px 32px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;
                animation: slideIn 0.3s ease; cursor: pointer;`;
            n.innerHTML = `<i class="fas fa-${icons[type] || icons.info}"></i><span>${msg}</span>`;
            n.onclick = () => dismissNotification(n);
            
            container.appendChild(n);
            notifications.push(n);
            
            // Auto dismiss
            setTimeout(() => dismissNotification(n), duration);
        }
        
        function dismissNotification(n) {
            if (!n || !n.parentNode) return;
            n.style.animation = 'slideOut 0.2s ease';
            setTimeout(() => {
                n.remove();
                const idx = notifications.indexOf(n);
                if (idx > -1) notifications.splice(idx, 1);
            }, 200);
        }
        
        // Symbol Modal
        function openSymbolModal() {
            document.getElementById('symbolModal').classList.add('active');
            document.getElementById('symbolSearch').focus();
            // Load fresh symbols from API
            fetchSymbolsFromAPI();
        }
        
        function closeSymbolModal() {
            document.getElementById('symbolModal').classList.remove('active');
        }
        
        let liveSymbols = symbols; // Will be updated with API data
        
        async function fetchSymbolsFromAPI(query = '') {
            const list = document.getElementById('symbolList');
            try {
                state.loading.symbols = true;
                list.innerHTML = '<div class="loading-overlay"><div class="loading-spinner"></div><span>Loading symbols...</span></div>';
                
                const params = new URLSearchParams({ limit: '50' });
                if (query) params.append('query', query);
                
                const res = await fetch(`/api/trading/symbols?${params}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.symbols && data.symbols.length > 0) {
                        liveSymbols = data.symbols.map(s => ({
                            symbol: s.symbol,
                            name: s.base,
                            price: s.price || 0,
                            change: s.change_24h || 0,
                            volume: s.volume_formatted || 'N/A',
                            funding: s.funding_rate ? (s.funding_rate * 100).toFixed(4) + '%' : null
                        }));
                        renderSymbolList();
                    }
                }
            } catch (e) {
                console.log('Symbol fetch error:', e);
                list.innerHTML = '<div class="error-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load symbols</p></div>';
            } finally {
                state.loading.symbols = false;
            }
        }
        
        function formatVolume(vol) {
            if (!vol || isNaN(vol)) return 'N/A';
            if (vol >= 1e9) return (vol / 1e9).toFixed(2) + 'B';
            if (vol >= 1e6) return (vol / 1e6).toFixed(2) + 'M';
            if (vol >= 1e3) return (vol / 1e3).toFixed(1) + 'K';
            return vol.toFixed(0);
        }
        
        function renderSymbolList(filter = '') {
            const list = document.getElementById('symbolList');
            const sourceSymbols = liveSymbols.length > 0 ? liveSymbols : symbols;
            const filtered = sourceSymbols.filter(s => 
                s.symbol.toLowerCase().includes(filter.toLowerCase()) || 
                s.name.toLowerCase().includes(filter.toLowerCase())
            );
            
            if (!filtered.length) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>No symbols found</p></div>';
                return;
            }
            
            list.innerHTML = filtered.map(s => `
                <div class="symbol-item" onclick="selectSymbol('${s.symbol}')">
                    <div class="symbol-item-info">
                        <div class="symbol-item-icon">${s.symbol.slice(0,2)}</div>
                        <div>
                            <div class="symbol-item-name">${s.symbol.replace('USDT', '')}</div>
                            <div class="symbol-item-full">${s.name} Perpetual</div>
                        </div>
                    </div>
                    <div class="symbol-item-stats">
                        <div class="symbol-item-price">
                            <div class="price">$${parseFloat(s.price || 0).toLocaleString(undefined, {maximumFractionDigits: 6})}</div>
                            <div class="change ${s.change >= 0 ? 'positive' : 'negative'}">${s.change >= 0 ? '+' : ''}${(s.change || 0).toFixed(2)}%</div>
                        </div>
                        <div class="symbol-item-volume">
                            <div class="volume-label">Vol 24h</div>
                            <div class="volume-value">${s.volume || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function filterSymbols() {
            renderSymbolList(document.getElementById('symbolSearch').value);
        }
        
        function selectSymbol(symbol) {
            state.symbol = symbol;
            const s = symbols.find(x => x.symbol === symbol);
            document.getElementById('symbolName').textContent = symbol;
            document.getElementById('symbolPrice').textContent = '$' + s.price.toLocaleString();
            document.getElementById('symbolChange').textContent = (s.change >= 0 ? '+' : '') + s.change.toFixed(2) + '%';
            document.getElementById('symbolChange').className = 'symbol-change ' + (s.change >= 0 ? 'positive' : 'negative');
            document.getElementById('sizeSymbol').textContent = symbol.replace('USDT', '');
            closeSymbolModal();
            initTradingView();
        }
        
        // Close modal on outside click
        document.getElementById('symbolModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeSymbolModal();
        });
        
        // ============================================================
        // ADVANCED TERMINAL FEATURES INTEGRATION
        // ============================================================
        
        // Initialize Risk Calculator
        function initRiskCalculator() {
            const panel = document.getElementById('riskCalcPanel');
            if (!panel) return;
            
            RiskCalculator.state.accountBalance = parseFloat(
                document.getElementById('availableBalance')?.textContent.replace(/[$,]/g, '') || 10000
            );
            RiskCalculator.state.leverage = state.leverage;
            
            // Update on input changes
            ['riskEntry', 'riskSL', 'riskTP', 'riskPercent'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {
                        RiskCalculator.state.entryPrice = parseFloat(document.getElementById('riskEntry')?.value) || 0;
                        RiskCalculator.state.stopLoss = parseFloat(document.getElementById('riskSL')?.value) || 0;
                        RiskCalculator.state.riskPercent = parseFloat(document.getElementById('riskPercent')?.value) || 1;
                        
                        const tp = parseFloat(document.getElementById('riskTP')?.value);
                        const result = tp ? RiskCalculator.setRiskReward(tp) : RiskCalculator.calculate();
                        
                        if (result) {
                            document.getElementById('riskResult').innerHTML = RiskCalculator.render();
                        }
                    });
                }
            });
        }
        
        // Initialize DCA Builder
        function initDCABuilder() {
            const panel = document.getElementById('dcaPanel');
            if (!panel) return;
            
            DCABuilder.state.entryPrice = state.lastPrice;
            DCABuilder.state.side = state.side;
        }
        
        // Enhanced orderbook with real data
        async function fetchRealOrderbook() {
            try {
                const res = await fetch(`/api/trading/orderbook/${state.symbol}?depth=25`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) {
                        updateOrderbookUI(data);
                    }
                }
            } catch (e) {
                console.log('Orderbook fetch error:', e);
            }
        }
        
        function updateOrderbookUI(data) {
            const asksEl = document.getElementById('asks');
            const bidsEl = document.getElementById('bids');
            if (!asksEl || !bidsEl) return;
            
            // Update heatmap analysis
            OrderbookHeatmap.update(data.asks, data.bids);
            
            // Render asks (reversed for display)
            asksEl.innerHTML = data.asks.slice().reverse().map(([price, size, total, depth]) => {
                const heatColor = OrderbookHeatmap.getHeatColor(size, 'ask');
                const isWhale = size > OrderbookHeatmap.state.maxSize * 0.3;
                return `<div class="orderbook-row ask ${isWhale ? 'whale' : ''}" onclick="setPrice(${price})" style="--heat-color: ${heatColor};">
                    <span class="price">${price.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                    <span class="size ${isWhale ? 'highlight' : ''}">${size.toFixed(4)}</span>
                    <span class="total">${total.toFixed(2)}</span>
                    <div class="depth" style="width: ${depth}%;"></div>
                    ${isWhale ? '<i class="fas fa-fish whale-icon"></i>' : ''}
                </div>`;
            }).join('');
            
            // Render bids
            bidsEl.innerHTML = data.bids.map(([price, size, total, depth]) => {
                const heatColor = OrderbookHeatmap.getHeatColor(size, 'bid');
                const isWhale = size > OrderbookHeatmap.state.maxSize * 0.3;
                return `<div class="orderbook-row bid ${isWhale ? 'whale' : ''}" onclick="setPrice(${price})" style="--heat-color: ${heatColor};">
                    <span class="price">${price.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                    <span class="size ${isWhale ? 'highlight' : ''}">${size.toFixed(4)}</span>
                    <span class="total">${total.toFixed(2)}</span>
                    <div class="depth" style="width: ${depth}%;"></div>
                    ${isWhale ? '<i class="fas fa-fish whale-icon"></i>' : ''}
                </div>`;
            }).join('');
            
            // Update spread
            if (data.asks.length && data.bids.length) {
                document.getElementById('spreadValue').textContent = '$' + data.spread.toFixed(2);
                document.getElementById('spreadPercent').textContent = data.spread_percent.toFixed(4) + '%';
                
                // Update imbalance indicator
                const imbalanceEl = document.getElementById('imbalanceIndicator');
                if (imbalanceEl) {
                    const color = data.imbalance > 10 ? 'var(--green)' : data.imbalance < -10 ? 'var(--red)' : 'var(--text-muted)';
                    const label = data.imbalance > 10 ? 'Bullish' : data.imbalance < -10 ? 'Bearish' : 'Neutral';
                    imbalanceEl.innerHTML = `
                        <div class="imbalance-bar"><div class="imbalance-fill" style="width: ${50 + data.imbalance/2}%; background: ${color};"></div></div>
                        <span class="imbalance-label" style="color: ${color};">${label} (${data.imbalance.toFixed(1)}%)</span>
                    `;
                }
            }
        }
        
        // One-Click Trading toggle
        function toggleOneClickTrading() {
            if (OneClickTrading.state.enabled) {
                OneClickTrading.disable();
                document.getElementById('oneClickToggle')?.classList.remove('active');
            } else {
                OneClickTrading.enable();
                document.getElementById('oneClickToggle')?.classList.add('active');
            }
        }
        
        // Show keyboard shortcuts
        function showShortcuts() {
            Shortcuts.showHelp();
        }
        
        // Enhanced WebSocket connection with orderbook streaming
        function connectAdvancedWebSocket() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const userId = localStorage.getItem('elcaro_user_id') || 0;
            
            const ws = new WebSocket(`${proto}//${location.host}/ws/terminal/${userId}`);
            
            ws.onopen = () => {
                console.log('Advanced WS connected');
                // Subscribe to orderbook updates
                ws.send(JSON.stringify({
                    type: 'subscribe_orderbook',
                    symbol: state.symbol
                }));
            };
            
            ws.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    
                    switch (data.type) {
                        case 'orderbook':
                            updateOrderbookUI(data);
                            break;
                        case 'trades':
                            updateRecentTrades(data.trades);
                            break;
                        case 'price_update':
                            updatePriceDisplay(data.data);
                            break;
                        case 'signal':
                            handleSignal(data.data);
                            break;
                        case 'positions':
                            renderPositions(data.data);
                            break;
                    }
                } catch (err) {
                    console.log('WS message error:', err);
                }
            };
            
            ws.onclose = () => {
                setTimeout(connectAdvancedWebSocket, 5000);
            };
            
            return ws;
        }
        
        function updateRecentTrades(trades) {
            const list = document.getElementById('tradesList');
            if (!list) return;
            
            const newTrades = trades.map(t => ({
                isBuy: t.side === 'Buy',
                price: t.price,
                size: t.size,
                time: new Date(t.time)
            }));
            
            state.recentTrades = [...newTrades, ...state.recentTrades].slice(0, 50);
            renderRecentTrades();
        }
        
        function updatePriceDisplay(data) {
            if (data.price) {
                state.lastPrice = data.price;
                document.getElementById('symbolPrice').textContent = '$' + data.price.toLocaleString();
            }
            if (data.change24h !== undefined) {
                const changeEl = document.getElementById('symbolChange');
                changeEl.textContent = (data.change24h >= 0 ? '+' : '') + data.change24h.toFixed(2) + '%';
                changeEl.className = 'symbol-change ' + (data.change24h >= 0 ? 'positive' : 'negative');
            }
        }
        
        function handleSignal(signal) {
            // Add to signal feed
            const feed = document.getElementById('signalFeed');
            if (feed) {
                const item = document.createElement('div');
                item.className = `signal-item ${signal.side.toLowerCase()}`;
                item.innerHTML = `
                    <div class="signal-info">
                        <span class="signal-strategy">${signal.strategy}</span>
                        <span class="signal-reason">${signal.reason}</span>
                    </div>
                    <span class="signal-confidence ${signal.confidence >= 0.75 ? 'high' : 'medium'}">
                        ${(signal.confidence * 100).toFixed(0)}%
                    </span>
                `;
                feed.insertBefore(item, feed.firstChild);
                
                // Keep only last 10 signals
                while (feed.children.length > 10) {
                    feed.removeChild(feed.lastChild);
                }
            }
            
            // Show notification
            Notifications.show(
                `${signal.strategy}: ${signal.side.toUpperCase()} ${signal.symbol}`,
                signal.side.toLowerCase() === 'buy' ? 'success' : 'warning',
                5000
            );
        }
        
        // ============================================================
        // PANEL TOGGLE FUNCTIONS
        // ============================================================
        
        function showRiskCalc() {
            document.getElementById('riskCalcPanel').style.display = 'block';
            document.getElementById('dcaPanel').style.display = 'none';
            // Pre-fill with current price
            document.getElementById('riskEntry').value = state.lastPrice || '';
        }
        
        function hideRiskCalc() {
            document.getElementById('riskCalcPanel').style.display = 'none';
        }
        
        function showDCABuilder() {
            document.getElementById('dcaPanel').style.display = 'block';
            document.getElementById('riskCalcPanel').style.display = 'none';
            updateDCAPreview();
        }
        
        function hideDCABuilder() {
            document.getElementById('dcaPanel').style.display = 'none';
        }
        
        function setRiskPreset(percent) {
            document.getElementById('riskPercent').value = percent;
            document.querySelectorAll('.risk-preset-btn').forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.textContent) === percent);
            });
            // Trigger recalculation
            document.getElementById('riskPercent').dispatchEvent(new Event('input'));
        }
        
        function applyRiskCalc() {
            const result = RiskCalculator.calculate();
            if (result) {
                document.getElementById('sizeInput').value = result.positionSize.toFixed(4);
                document.getElementById('priceInput').value = RiskCalculator.state.entryPrice;
                
                // Set TP/SL if calculated
                if (document.getElementById('riskSL').value) {
                    state.tpslEnabled = true;
                    document.getElementById('tpslToggle').classList.add('active');
                    document.getElementById('tpslInputs').style.display = 'grid';
                    document.getElementById('slInput').value = document.getElementById('riskSL').value;
                }
                if (document.getElementById('riskTP').value) {
                    document.getElementById('tpInput').value = document.getElementById('riskTP').value;
                }
                
                hideRiskCalc();
                updateOrderSummary();
                Notifications.show('Position size applied from Risk Calculator', 'success');
            }
        }
        
        // ============================================================
        // DCA BUILDER FUNCTIONS
        // ============================================================
        
        function updateDCAPreview() {
            const totalSize = parseFloat(document.getElementById('dcaTotalSize').value) || 0.1;
            const orderCount = parseInt(document.getElementById('dcaOrderCount').value) || 5;
            const range = parseFloat(document.getElementById('dcaRange').value) || 5;
            const distribution = document.getElementById('dcaDistribution').value;
            const entryPrice = state.lastPrice || 0;
            
            if (!entryPrice) return;
            
            // Calculate weights
            const weights = {
                linear: Array(orderCount).fill(1),
                geometric: Array.from({length: orderCount}, (_, i) => Math.pow(1.5, i)),
                fibonacci: (() => { let f = [1, 1]; for(let i = 2; i < orderCount; i++) f.push(f[i-1]+f[i-2]); return f.slice(0, orderCount); })(),
                exponential: Array.from({length: orderCount}, (_, i) => Math.pow(2, i))
            }[distribution] || Array(orderCount).fill(1);
            
            const totalWeight = weights.reduce((a, b) => a + b, 0);
            const priceStep = (entryPrice * range / 100) / (orderCount - 1);
            const isBuy = state.side === 'buy';
            
            const orders = [];
            let totalValue = 0;
            
            for (let i = 0; i < orderCount; i++) {
                const size = totalSize * (weights[i] / totalWeight);
                const price = isBuy ? entryPrice - (priceStep * i) : entryPrice + (priceStep * i);
                const value = price * size;
                totalValue += value;
                
                orders.push({
                    index: i + 1,
                    price: price.toFixed(2),
                    size: size.toFixed(4),
                    pct: ((price - entryPrice) / entryPrice * 100).toFixed(2)
                });
            }
            
            // Calculate average entry
            const avgEntry = totalValue / totalSize;
            
            // Update summary
            document.getElementById('dcaSummary').innerHTML = `
                <div class="dca-stat">
                    <span>Avg Entry</span>
                    <strong>$${avgEntry.toFixed(2)}</strong>
                </div>
                <div class="dca-stat">
                    <span>Total Value</span>
                    <strong>$${totalValue.toFixed(2)}</strong>
                </div>
                <div class="dca-stat">
                    <span>Range</span>
                    <strong>${range}%</strong>
                </div>
            `;
            
            // Update orders list
            document.getElementById('dcaOrdersList').innerHTML = orders.map(o => `
                <div class="dca-order ${state.side}">
                    <span class="order-num">#${o.index}</span>
                    <span class="order-price">$${parseFloat(o.price).toLocaleString()}</span>
                    <span class="order-size">${o.size}</span>
                    <span class="order-pct">${o.pct}%</span>
                </div>
            `).join('');
        }
        
        async function placeDCALadder() {
            const totalSize = parseFloat(document.getElementById('dcaTotalSize').value) || 0.1;
            const orderCount = parseInt(document.getElementById('dcaOrderCount').value) || 5;
            const range = parseFloat(document.getElementById('dcaRange').value) || 5;
            const distribution = document.getElementById('dcaDistribution').value;
            
            if (!state.lastPrice) {
                Notifications.show('Price not available', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('elcaro_token');
                const res = await fetch('/api/trading/dca-ladder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        symbol: state.symbol,
                        side: state.side,
                        total_size: totalSize,
                        order_count: orderCount,
                        price_range_percent: range,
                        distribution: distribution,
                        entry_price: state.lastPrice,
                        exchange: state.exchange || 'bybit',
                        account_type: document.getElementById('accountSelect')?.value || 'demo',
                        leverage: state.leverage
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    Notifications.show(`Placed ${data.placed}/${data.total} DCA orders`, 'success');
                    hideDCABuilder();
                    loadPositions();
                } else {
                    Notifications.show(data.error || 'Failed to place DCA orders', 'error');
                }
            } catch (e) {
                Notifications.show('Error placing DCA orders', 'error');
            }
        }
        
        // Add event listeners for DCA inputs
        ['dcaTotalSize', 'dcaOrderCount', 'dcaRange', 'dcaDistribution'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', updateDCAPreview);
                el.addEventListener('change', updateDCAPreview);
            }
        });
        
        // ============================================================
        // ALERTS PANEL UPDATE
        // ============================================================
        
        function updateAlertsPanel() {
            const list = document.getElementById('alertsList');
            if (!list || typeof SmartAlerts === 'undefined') return;
            
            const activeAlerts = SmartAlerts.alerts.filter(a => a.active);
            
            if (activeAlerts.length === 0) {
                list.innerHTML = '<p class="empty">No active alerts</p>';
                return;
            }
            
            list.innerHTML = activeAlerts.map(a => `
                <div class="alert-item">
                    <div class="alert-info">
                        <span class="alert-symbol">${a.symbol}</span>
                        <span class="alert-condition">${a.condition} $${a.value.toLocaleString()}</span>
                    </div>
                    <button class="alert-remove" onclick="SmartAlerts.remove(${a.id}); updateAlertsPanel();">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Initialize advanced features on load
        document.addEventListener('DOMContentLoaded', () => {
            // Load user settings from server
            loadUserSettings();
            
            // Connect to Settings Sync WebSocket
            connectSettingsSyncWebSocket();
            
            // Load advanced JS module
            const script = document.createElement('script');
            script.src = '/static/js/terminal-advanced.js';
            script.onload = () => {
                initRiskCalculator();
                initDCABuilder();
                SmartAlerts.load();
                PositionAnalytics.fetchStats();
                updateAlertsPanel();
                
                // Start real orderbook polling (fallback if WS not available)
                setInterval(fetchRealOrderbook, 2000);
                
                // Periodic alerts panel update
                setInterval(updateAlertsPanel, 5000);
            };
            document.body.appendChild(script);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
        
        // ============================================================
        // EXCHANGE & ACCOUNT SWITCHING
        // ============================================================
        
        async function loadUserSettings() {
            try {
                const token = localStorage.getItem('elcaro_token');
                if (!token) return;
                
                const res = await fetch('/api/users/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.user) {
                        // Set exchange and account type from user settings
                        state.exchange = data.user.exchange_type || 'bybit';
                        state.accountType = data.user.trading_mode || 'demo';
                        state.leverage = data.user.leverage || 10;
                        
                        // Update UI
                        document.getElementById('exchangeSelect').value = state.exchange;
                        document.getElementById('accountSelect').value = state.accountType;
                        updateAccountBadge();
                        updateExchangeUI();
                        setLeverage(state.leverage);
                    }
                }
            } catch (e) {
                console.error('Failed to load user settings:', e);
            }
        }
        
        async function changeExchange() {
            const newExchange = document.getElementById('exchangeSelect').value;
            if (newExchange === state.exchange) return;
            
            const prevExchange = state.exchange;
            state.exchange = newExchange;
            
            try {
                const token = localStorage.getItem('elcaro_token');
                const res = await fetch('/api/users/exchange', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ 
                        exchange: newExchange,
                        reconnect: true
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification(`Switched to ${newExchange.toUpperCase()}`, 'success');
                    updateExchangeUI();
                    updateAccountTypeOptions();
                    
                    // Reconnect WebSocket for new exchange
                    reconnectWebSockets();
                    
                    // Reload positions for new exchange
                    loadPositions();
                    
                    // Update balance display
                    if (data.balance) {
                        document.getElementById('availableBalance').textContent = '$' + data.balance.available.toLocaleString();
                        document.getElementById('equity').textContent = '$' + data.balance.equity.toLocaleString();
                    }
                } else {
                    // Revert on failure
                    state.exchange = prevExchange;
                    document.getElementById('exchangeSelect').value = prevExchange;
                    showNotification(data.error || 'Failed to switch exchange', 'error');
                }
            } catch (e) {
                state.exchange = prevExchange;
                document.getElementById('exchangeSelect').value = prevExchange;
                showNotification('Connection error', 'error');
            }
        }
        
        async function changeAccountType() {
            const newAccountType = document.getElementById('accountSelect').value;
            if (newAccountType === state.accountType) return;
            
            const prevAccountType = state.accountType;
            state.accountType = newAccountType;
            
            try {
                const token = localStorage.getItem('elcaro_token');
                const res = await fetch('/api/users/switch-account-type', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ 
                        account_type: newAccountType,
                        exchange: state.exchange
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification(`Switched to ${newAccountType.toUpperCase()}`, 'success');
                    updateAccountBadge();
                    
                    // Reload positions for new account type
                    loadPositions();
                    
                    // Update balance
                    if (data.balance) {
                        document.getElementById('availableBalance').textContent = '$' + data.balance.available.toLocaleString();
                        document.getElementById('equity').textContent = '$' + data.balance.equity.toLocaleString();
                    }
                } else {
                    state.accountType = prevAccountType;
                    document.getElementById('accountSelect').value = prevAccountType;
                    showNotification(data.error || 'Failed to switch account', 'error');
                }
            } catch (e) {
                state.accountType = prevAccountType;
                document.getElementById('accountSelect').value = prevAccountType;
                showNotification('Connection error', 'error');
            }
        }
        
        function updateAccountBadge() {
            const badge = document.getElementById('accountBadge');
            if (state.accountType === 'demo' || state.accountType === 'testnet') {
                badge.className = 'demo-badge';
                badge.textContent = 'DEMO';
            } else {
                badge.className = 'real-badge';
                badge.textContent = 'REAL';
            }
        }
        
        function updateAccountTypeOptions() {
            const select = document.getElementById('accountSelect');
            select.innerHTML = '';
            
            if (state.exchange === 'bybit') {
                select.innerHTML = `
                    <option value="demo">Demo</option>
                    <option value="real">Real</option>
                `;
            } else if (state.exchange === 'hyperliquid') {
                select.innerHTML = `
                    <option value="testnet">Testnet</option>
                    <option value="mainnet">Mainnet</option>
                `;
            }
            
            // Set current value
            if (state.exchange === 'hyperliquid') {
                state.accountType = state.accountType === 'demo' ? 'testnet' : 
                                    state.accountType === 'real' ? 'mainnet' : state.accountType;
            } else {
                state.accountType = state.accountType === 'testnet' ? 'demo' : 
                                    state.accountType === 'mainnet' ? 'real' : state.accountType;
            }
            
            select.value = state.accountType;
            updateAccountBadge();
        }
        
        function updateExchangeUI() {
            const exchangeBadge = document.querySelector('.exchange-select');
            const logo = document.querySelector('.logo-icon');
            
            // Update exchange-specific styling
            document.body.setAttribute('data-exchange', state.exchange);
            
            if (state.exchange === 'hyperliquid') {
                // HyperLiquid specific features
                document.querySelectorAll('.bybit-only').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.hl-only').forEach(el => el.style.display = '');
                
                // Update max leverage for HyperLiquid
                const slider = document.getElementById('leverageSlider');
                slider.max = 50; // HyperLiquid max
                if (state.leverage > 50) setLeverage(50);
                
                // Update leverage marks
                const marks = document.querySelector('.leverage-marks');
                if (marks) {
                    marks.innerHTML = `
                        <span onclick="setLeverage(1)">1x</span>
                        <span onclick="setLeverage(5)">5x</span>
                        <span onclick="setLeverage(10)">10x</span>
                        <span onclick="setLeverage(20)">20x</span>
                        <span onclick="setLeverage(50)">50x</span>
                    `;
                }
                
                // HyperLiquid doesn't have margin mode selection
                document.querySelector('.margin-mode-row')?.classList.add('hl-hidden');
                
            } else {
                // Bybit specific features
                document.querySelectorAll('.bybit-only').forEach(el => el.style.display = '');
                document.querySelectorAll('.hl-only').forEach(el => el.style.display = 'none');
                
                // Restore max leverage for Bybit
                const slider = document.getElementById('leverageSlider');
                slider.max = 100;
                
                // Restore leverage marks
                const marks = document.querySelector('.leverage-marks');
                if (marks) {
                    marks.innerHTML = `
                        <span onclick="setLeverage(1)">1x</span>
                        <span onclick="setLeverage(5)">5x</span>
                        <span onclick="setLeverage(10)">10x</span>
                        <span onclick="setLeverage(25)">25x</span>
                        <span onclick="setLeverage(50)">50x</span>
                        <span onclick="setLeverage(100)">100x</span>
                    `;
                }
                
                document.querySelector('.margin-mode-row')?.classList.remove('hl-hidden');
            }
            
            // Update TradingView chart symbol prefix
            initTradingView();
        }
        
        function reconnectWebSockets() {
            // Close existing connections
            if (state.ws) {
                state.ws.close();
            }
            
            // Reconnect with new exchange context
            setTimeout(() => {
                connectWebSocket();
                connectAdvancedWebSocket();
            }, 500);
        }
        
        // ============================================================
        // SETTINGS SYNC WEBSOCKET
        // ============================================================
        
        function connectSettingsSyncWebSocket() {
            let userId = localStorage.getItem('elcaro_user_id');
            
            // Fallback: try to get from elcaro_user object
            if (!userId) {
                try {
                    const userObj = JSON.parse(localStorage.getItem('elcaro_user') || '{}');
                    if (userObj.user_id) {
                        userId = userObj.user_id.toString();
                        localStorage.setItem('elcaro_user_id', userId);
                    }
                } catch (e) {}
            }
            
            if (!userId) {
                console.log('No user_id for settings sync, will retry after auth');
                return;
            }
            
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            
            try {
                state.settingsWs = new WebSocket(`${proto}//${location.host}/ws/settings-sync/${userId}`);
                
                state.settingsWs.onopen = () => {
                    console.log('Settings sync connected');
                    // Request current settings
                    state.settingsWs.send(JSON.stringify({ type: 'get_settings' }));
                };
                
                state.settingsWs.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        handleSettingsSyncMessage(data);
                    } catch (err) {
                        console.log('Settings sync parse error:', err);
                    }
                };
                
                state.settingsWs.onclose = () => {
                    console.log('Settings sync disconnected, reconnecting...');
                    setTimeout(connectSettingsSyncWebSocket, 5000);
                };
                
                state.settingsWs.onerror = () => {
                    state.settingsWs.close();
                };
            } catch (e) {
                console.error('Failed to connect settings sync:', e);
            }
        }
        
        function handleSettingsSyncMessage(data) {
            switch (data.type) {
                case 'exchange_switched':
                    // Another device switched exchange
                    if (data.exchange !== state.exchange) {
                        state.exchange = data.exchange;
                        document.getElementById('exchangeSelect').value = data.exchange;
                        updateExchangeUI();
                        updateAccountTypeOptions();
                        showNotification(`Exchange switched to ${data.exchange.toUpperCase()} from another device`, 'info');
                        reconnectWebSockets();
                        loadPositions();
                    }
                    break;
                    
                case 'settings_changed':
                    // Settings updated from another source
                    if (data.settings) {
                        if (data.settings.leverage && data.settings.leverage !== state.leverage) {
                            setLeverage(data.settings.leverage);
                        }
                        if (data.settings.trading_mode && data.settings.trading_mode !== state.accountType) {
                            state.accountType = data.settings.trading_mode;
                            document.getElementById('accountSelect').value = state.accountType;
                            updateAccountBadge();
                        }
                    }
                    break;
                    
                case 'strategy_deployed':
                    // Strategy was deployed from backtest
                    showNotification(`Strategy "${data.strategy_name}" deployed! Parameters applied.`, 'success');
                    if (data.params) {
                        // Apply strategy parameters
                        if (data.params.leverage) setLeverage(data.params.leverage);
                        if (data.params.tp_percent) {
                            document.getElementById('tpInput').value = data.params.tp_percent;
                        }
                        if (data.params.sl_percent) {
                            document.getElementById('slInput').value = data.params.sl_percent;
                        }
                    }
                    break;
                    
                case 'preset_loaded':
                    // User loaded a preset from marketplace
                    showNotification(`Preset "${data.preset_name}" loaded`, 'success');
                    loadUserSettings(); // Reload all settings
                    break;
                    
                case 'credentials_updated':
                    // API credentials were updated
                    showNotification('API credentials updated, reconnecting...', 'info');
                    reconnectWebSockets();
                    loadPositions();
                    break;
                    
                case 'current_settings':
                    // Initial settings load
                    if (data.settings) {
                        state.exchange = data.settings.exchange_type || 'bybit';
                        state.accountType = data.settings.trading_mode || 'demo';
                        state.leverage = data.settings.leverage || 10;
                        
                        document.getElementById('exchangeSelect').value = state.exchange;
                        updateAccountTypeOptions();
                        setLeverage(state.leverage);
                        updateExchangeUI();
                    }
                    break;
            }
        }
        
        // Notify settings changes to sync
        function notifySettingsChange(changeType, data) {
            if (state.settingsWs && state.settingsWs.readyState === WebSocket.OPEN) {
                state.settingsWs.send(JSON.stringify({
                    type: 'update_setting',
                    change_type: changeType,
                    data: data
                }));
            }
        }
    </script>
</body>
</html>