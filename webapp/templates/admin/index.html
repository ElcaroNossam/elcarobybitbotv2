<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050505">
    <title>Admin Panel - Enliko Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Toast Notifications -->
    <script src="/static/js/toast-notifications.js"></script>
    
    <!-- Mobile Responsive CSS -->
    <link rel="stylesheet" href="/static/css/mobile.css">
    
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .tab-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card:hover { transform: translateY(-2px); transition: all 0.3s; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gray-900/80 backdrop-blur-lg border-b border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">
                    üîß Admin Panel
                </h1>
                <span class="text-xs text-gray-500">Enliko Trading v2.0</span>
            </div>
            <div class="flex items-center gap-4">
                <a href="/dashboard" class="text-gray-400 hover:text-white transition">Dashboard</a>
                <a href="/marketplace" class="text-gray-400 hover:text-white transition">Marketplace</a>
                <button onclick="logout()" class="px-4 py-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Tabs -->
    <div class="container mx-auto px-6 py-4">
        <div class="flex gap-2 border-b border-gray-800 pb-4">
            <button onclick="showTab('overview')" id="tab-overview" class="px-4 py-2 rounded-lg tab-active text-white">
                üìä Overview
            </button>
            <button onclick="showTab('users')" id="tab-users" class="px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:text-white transition">
                üë• Users
            </button>
            <button onclick="showTab('strategies')" id="tab-strategies" class="px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:text-white transition">
                üéØ Strategies
            </button>
            <button onclick="showTab('marketplace')" id="tab-marketplace" class="px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:text-white transition">
                üõí Marketplace
            </button>
            <button onclick="showTab('payouts')" id="tab-payouts" class="px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:text-white transition">
                üí∞ Payouts
            </button>
            <button onclick="showTab('licenses')" id="tab-licenses" class="px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:text-white transition">
                üîë Licenses
            </button>
            <button onclick="showTab('finances')" id="tab-finances" class="px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:text-white transition">
                üìà Finances
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-4">
        <!-- Overview Tab -->
        <div id="content-overview" class="tab-content">
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="glass rounded-xl p-6 stat-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-gray-400 text-sm">Total Users</h3>
                            <p class="text-3xl font-bold mt-2" id="totalUsers">0</p>
                        </div>
                        <span class="text-3xl">üë•</span>
                    </div>
                    <p class="text-green-400 text-sm mt-2"><span id="newUsersToday">0</span> new today</p>
                </div>
                <div class="glass rounded-xl p-6 stat-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-gray-400 text-sm">Premium Users</h3>
                            <p class="text-3xl font-bold mt-2 text-purple-400" id="premiumUsers">0</p>
                        </div>
                        <span class="text-3xl">‚óà</span>
                    </div>
                    <p class="text-gray-500 text-sm mt-2"><span id="premiumPercent">0</span>% of total</p>
                </div>
                <div class="glass rounded-xl p-6 stat-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-gray-400 text-sm">HyperLiquid Users</h3>
                            <p class="text-3xl font-bold mt-2 text-cyan-400" id="hlUsers">0</p>
                        </div>
                        <span class="text-3xl">üåä</span>
                    </div>
                    <p class="text-gray-500 text-sm mt-2">DEX enabled</p>
                </div>
                <div class="glass rounded-xl p-6 stat-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-gray-400 text-sm">Active Strategies</h3>
                            <p class="text-3xl font-bold mt-2 text-pink-400" id="activeStrategies">0</p>
                        </div>
                        <span class="text-3xl">üéØ</span>
                    </div>
                    <p class="text-gray-500 text-sm mt-2"><span id="publicStrategies">0</span> public</p>
                </div>
            </div>

            <!-- System Status -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">System Status</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-gray-800/50 rounded-lg p-4 flex items-center gap-4">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
                        <div>
                            <p class="font-medium">Bot Service</p>
                            <p class="text-sm text-gray-400">Running</p>
                        </div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-4 flex items-center gap-4">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
                        <div>
                            <p class="font-medium">WebApp</p>
                            <p class="text-sm text-gray-400">Running on port 8765</p>
                        </div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-4 flex items-center gap-4">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse"></div>
                        <div>
                            <p class="font-medium">Database</p>
                            <p class="text-sm text-gray-400">SQLite WAL mode</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="content-users" class="tab-content hidden">
            <div class="glass rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">User Management</h2>
                    <div class="flex gap-2">
                        <input type="text" id="userSearch" placeholder="Search users..." 
                               class="px-4 py-2 bg-gray-800 rounded-lg border border-gray-700 focus:border-purple-500 outline-none">
                        <button onclick="searchUsers()" class="px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-700">Search</button>
                    </div>
                </div>
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="p-3">ID</th>
                            <th class="p-3">Username</th>
                            <th class="p-3">License</th>
                            <th class="p-3">Exchange</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
                <div id="usersPagination" class="flex justify-center gap-2 mt-4"></div>
            </div>
        </div>

        <!-- Strategies Tab -->
        <div id="content-strategies" class="tab-content hidden">
            <div class="glass rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Custom Strategies</h2>
                    <button onclick="refreshRankings()" class="px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-700">
                        üîÑ Refresh Rankings
                    </button>
                </div>
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="p-3">ID</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Creator</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Performance</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="strategiesTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Marketplace Tab -->
        <div id="content-marketplace" class="tab-content hidden">
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="glass rounded-xl p-6 stat-card">
                    <h3 class="text-gray-400 text-sm">Active Listings</h3>
                    <p class="text-3xl font-bold mt-2" id="activeListings">0</p>
                </div>
                <div class="glass rounded-xl p-6 stat-card">
                    <h3 class="text-gray-400 text-sm">Total Sales</h3>
                    <p class="text-3xl font-bold mt-2 text-green-400" id="totalSales">0</p>
                </div>
                <div class="glass rounded-xl p-6 stat-card">
                    <h3 class="text-gray-400 text-sm">Total Revenue</h3>
                    <p class="text-3xl font-bold mt-2 text-purple-400">$<span id="totalRevenue">0</span></p>
                </div>
                <div class="glass rounded-xl p-6 stat-card">
                    <h3 class="text-gray-400 text-sm">Platform Share (50%)</h3>
                    <p class="text-3xl font-bold mt-2 text-pink-400">$<span id="platformRevenue">0</span></p>
                </div>
            </div>

            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">Top Sellers</h3>
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="p-3">Seller ID</th>
                            <th class="p-3">Sales</th>
                            <th class="p-3">Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="topSellersTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Payouts Tab -->
        <div id="content-payouts" class="tab-content hidden">
            <div class="glass rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Payout Requests</h2>
                    <select id="payoutFilter" onchange="loadPayouts()" class="px-4 py-2 bg-gray-800 rounded-lg border border-gray-700">
                        <option value="">All</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="p-3">ID</th>
                            <th class="p-3">Seller</th>
                            <th class="p-3">Amount</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Requested</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payoutsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Licenses Tab -->
        <div id="content-licenses" class="tab-content hidden">
            <div class="glass rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">License Keys</h2>
                    <button onclick="showCreateLicense()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">
                        + Create License
                    </button>
                </div>
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800">
                            <th class="p-3">Key</th>
                            <th class="p-3">Type</th>
                            <th class="p-3">User</th>
                            <th class="p-3">Expires</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="licensesTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Finances Tab -->
        <div id="content-finances" class="tab-content hidden">
            <!-- Revenue Overview Cards -->
            <div class="grid md:grid-cols-5 gap-4 mb-6">
                <div class="glass rounded-xl p-5 stat-card">
                    <h3 class="text-gray-400 text-sm">Revenue (Period)</h3>
                    <p class="text-2xl font-bold mt-2 text-green-400">$<span id="totalRevenuePeriod">0</span></p>
                    <p class="text-gray-500 text-xs mt-1"><span id="transactionCount">0</span> transactions</p>
                </div>
                <div class="glass rounded-xl p-5 stat-card">
                    <h3 class="text-gray-400 text-sm">MRR</h3>
                    <p class="text-2xl font-bold mt-2 text-blue-400">$<span id="mrrValue">0</span></p>
                    <p class="text-gray-500 text-xs mt-1">Monthly Recurring Revenue</p>
                </div>
                <div class="glass rounded-xl p-5 stat-card">
                    <h3 class="text-gray-400 text-sm">ARR</h3>
                    <p class="text-2xl font-bold mt-2 text-purple-400">$<span id="arrValue">0</span></p>
                    <p class="text-gray-500 text-xs mt-1">Annual Recurring Revenue</p>
                </div>
                <div class="glass rounded-xl p-5 stat-card">
                    <h3 class="text-gray-400 text-sm">Active Subs</h3>
                    <p class="text-2xl font-bold mt-2 text-cyan-400"><span id="activeSubsCount">0</span></p>
                    <p class="text-gray-500 text-xs mt-1">Premium: <span id="premiumSubsCount">0</span></p>
                </div>
                <div class="glass rounded-xl p-5 stat-card">
                    <h3 class="text-gray-400 text-sm">ELC Tokens</h3>
                    <p class="text-2xl font-bold mt-2 text-pink-400"><span id="trcPurchased">0</span></p>
                    <p class="text-gray-500 text-xs mt-1">Purchased this period</p>
                </div>
            </div>

            <!-- Period Selector & Actions -->
            <div class="glass rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-2">
                    <button onclick="loadFinances('day')" class="period-btn px-3 py-1.5 rounded bg-gray-700 text-sm hover:bg-gray-600" data-period="day">Day</button>
                    <button onclick="loadFinances('week')" class="period-btn px-3 py-1.5 rounded bg-gray-700 text-sm hover:bg-gray-600" data-period="week">Week</button>
                    <button onclick="loadFinances('month')" class="period-btn px-3 py-1.5 rounded bg-purple-600 text-sm" data-period="month">Month</button>
                    <button onclick="loadFinances('quarter')" class="period-btn px-3 py-1.5 rounded bg-gray-700 text-sm hover:bg-gray-600" data-period="quarter">Quarter</button>
                    <button onclick="loadFinances('year')" class="period-btn px-3 py-1.5 rounded bg-gray-700 text-sm hover:bg-gray-600" data-period="year">Year</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="showExportModal()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700 text-sm">
                        üì• Export
                    </button>
                    <button onclick="loadPendingPayments()" class="px-4 py-2 bg-yellow-600 rounded-lg hover:bg-yellow-700 text-sm">
                        ‚è≥ Pending (<span id="pendingPaymentsCount">0</span>)
                    </button>
                </div>
            </div>

            <!-- Revenue Chart -->
            <div class="glass rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Revenue Chart</h3>
                    <select id="chartGroupBy" onchange="loadRevenueChart()" class="px-3 py-1.5 bg-gray-800 rounded border border-gray-700 text-sm">
                        <option value="day">Daily</option>
                        <option value="week">Weekly</option>
                        <option value="month">Monthly</option>
                    </select>
                </div>
                <canvas id="revenueChart" height="100"></canvas>
            </div>

            <!-- Payment Methods & Subscriptions Grid -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Payment Methods Breakdown -->
                <div class="glass rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Payment Methods</h3>
                    <div id="paymentMethodsList" class="space-y-3">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>

                <!-- Subscription Analytics -->
                <div class="glass rounded-xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Subscription Breakdown</h3>
                    <div id="subscriptionBreakdown" class="space-y-3">
                        <p class="text-gray-500">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="glass rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Recent Transactions</h3>
                    <div class="flex gap-2">
                        <select id="txStatusFilter" onchange="loadTransactions()" class="px-3 py-1.5 bg-gray-800 rounded border border-gray-700 text-sm">
                            <option value="">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                </div>
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-gray-800 text-sm">
                            <th class="p-3">Date</th>
                            <th class="p-3">User</th>
                            <th class="p-3">Type</th>
                            <th class="p-3">Method</th>
                            <th class="p-3">Amount</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable"></tbody>
                </table>
                <div id="txPagination" class="flex justify-center gap-2 mt-4"></div>
            </div>
        </div>
    </main>

    <!-- Create License Modal -->
    <div id="licenseModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="glass rounded-xl p-8 w-full max-w-md">
            <h3 class="text-xl font-bold mb-6">Create License</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">License Type</label>
                    <select id="licenseType" class="w-full px-4 py-2 bg-gray-800 rounded-lg border border-gray-700">
                        <option value="premium">Premium</option>
                        <option value="pro">Pro</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Duration (days)</label>
                    <input type="number" id="licenseDays" value="30" 
                           class="w-full px-4 py-2 bg-gray-800 rounded-lg border border-gray-700">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">User ID (optional)</label>
                    <input type="number" id="licenseUserId" placeholder="Leave empty for unassigned"
                           class="w-full px-4 py-2 bg-gray-800 rounded-lg border border-gray-700">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="hideLicenseModal()" class="px-4 py-2 bg-gray-700 rounded-lg">Cancel</button>
                <button onclick="createLicense()" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">Create</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('enliko_token');
        if (!token) window.location.href = '/login';

        let currentUsersPage = 1;

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active', 'text-white');
                el.classList.add('bg-gray-800', 'text-gray-400');
            });
            
            document.getElementById('content-' + tab).classList.remove('hidden');
            const tabBtn = document.getElementById('tab-' + tab);
            tabBtn.classList.add('tab-active', 'text-white');
            tabBtn.classList.remove('bg-gray-800', 'text-gray-400');

            if (tab === 'users') loadUsers();
            if (tab === 'strategies') loadStrategies();
            if (tab === 'marketplace') loadMarketplace();
            if (tab === 'payouts') loadPayouts();
            if (tab === 'licenses') loadLicenses();
            if (tab === 'finances') loadFinances('month');
        }

        async function api(endpoint, options = {}) {
            const res = await fetch(`/api/admin${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (res.status === 403) {
                alert('Admin access required');
                window.location.href = '/dashboard';
                return null;
            }
            return res.json();
        }

        async function loadOverview() {
            const stats = await api('/stats');
            if (!stats) return;

            document.getElementById('totalUsers').textContent = stats.users?.total || 0;
            document.getElementById('premiumUsers').textContent = stats.users?.premium || 0;
            document.getElementById('hlUsers').textContent = stats.users?.hyperliquid || 0;
            document.getElementById('newUsersToday').textContent = stats.users?.new_today || 0;
            
            const total = stats.users?.total || 1;
            const premium = stats.users?.premium || 0;
            document.getElementById('premiumPercent').textContent = ((premium / total) * 100).toFixed(1);

            const strategies = await api('/strategies');
            if (strategies) {
                document.getElementById('activeStrategies').textContent = strategies.total || 0;
                document.getElementById('publicStrategies').textContent = strategies.public || 0;
            }
        }

        async function loadUsers(page = 1) {
            currentUsersPage = page;
            const search = document.getElementById('userSearch')?.value || '';
            const data = await api(`/users?page=${page}&limit=20&search=${encodeURIComponent(search)}`);
            if (!data) return;

            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = data.list.map(u => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="p-3">${u.user_id}</td>
                    <td class="p-3">@${u.username || 'N/A'}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            u.license_type === 'premium' || u.license_type === 'lifetime' 
                            ? 'bg-purple-600/30 text-purple-400' 
                            : 'bg-gray-600/30 text-gray-400'
                        }">${u.license_type || 'free'}</span>
                    </td>
                    <td class="p-3">${u.exchange_type}</td>
                    <td class="p-3">
                        ${u.is_banned 
                            ? '<span class="text-red-400">Banned</span>'
                            : u.is_allowed 
                                ? '<span class="text-green-400">Active</span>'
                                : '<span class="text-yellow-400">Pending</span>'
                        }
                    </td>
                    <td class="p-3">
                        ${u.is_banned
                            ? `<button onclick="unbanUser(${u.user_id})" class="text-green-400 hover:text-green-300">Unban</button>`
                            : `<button onclick="banUser(${u.user_id})" class="text-red-400 hover:text-red-300">Ban</button>`
                        }
                        ${!u.is_allowed && !u.is_banned
                            ? `<button onclick="approveUser(${u.user_id})" class="ml-2 text-green-400 hover:text-green-300">Approve</button>`
                            : ''
                        }
                    </td>
                </tr>
            `).join('');
        }

        function searchUsers() { loadUsers(1); }
        async function banUser(id) { if (confirm('Ban this user?')) { await api(`/users/${id}/ban`, { method: 'POST' }); loadUsers(currentUsersPage); } }
        async function unbanUser(id) { await api(`/users/${id}/unban`, { method: 'POST' }); loadUsers(currentUsersPage); }
        async function approveUser(id) { await api(`/users/${id}/approve`, { method: 'POST' }); loadUsers(currentUsersPage); }

        async function loadStrategies() {
            const data = await api('/strategies');
            if (!data) return;

            const tbody = document.getElementById('strategiesTable');
            tbody.innerHTML = data.list.map(s => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="p-3">${s.id}</td>
                    <td class="p-3">${s.name}</td>
                    <td class="p-3">@${s.username || s.user_id}</td>
                    <td class="p-3">
                        ${s.is_public ? '<span class="text-green-400">Public</span>' : '<span class="text-gray-400">Private</span>'}
                        ${s.is_active ? '' : '<span class="text-red-400 ml-2">Inactive</span>'}
                    </td>
                    <td class="p-3">${s.performance_stats || 'N/A'}</td>
                    <td class="p-3 space-x-2">
                        ${!s.is_public 
                            ? `<button onclick="approveStrategy(${s.id})" class="text-green-400">Approve</button>`
                            : `<button onclick="rejectStrategy(${s.id})" class="text-yellow-400">Unpublish</button>`
                        }
                        <button onclick="deleteStrategy(${s.id})" class="text-red-400">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function approveStrategy(id) { await api(`/strategies/${id}/approve`, { method: 'POST' }); loadStrategies(); }
        async function rejectStrategy(id) { await api(`/strategies/${id}/reject`, { method: 'POST' }); loadStrategies(); }
        async function deleteStrategy(id) { if (confirm('Delete strategy?')) { await api(`/strategies/${id}`, { method: 'DELETE' }); loadStrategies(); } }
        async function refreshRankings() { await api('/rankings/refresh', { method: 'POST' }); alert('Rankings refreshed!'); }

        async function loadMarketplace() {
            const data = await api('/strategies/marketplace');
            if (!data) return;
            document.getElementById('activeListings').textContent = data.active_listings || 0;
            document.getElementById('totalSales').textContent = data.total_sales || 0;
            document.getElementById('totalRevenue').textContent = (data.total_revenue || 0).toFixed(2);
            document.getElementById('platformRevenue').textContent = (data.platform_revenue || 0).toFixed(2);

            const tbody = document.getElementById('topSellersTable');
            tbody.innerHTML = (data.top_sellers || []).map(s => `
                <tr class="border-b border-gray-800">
                    <td class="p-3">${s.seller_id}</td>
                    <td class="p-3">${s.sales}</td>
                    <td class="p-3 text-green-400">$${s.revenue?.toFixed(2) || 0}</td>
                </tr>
            `).join('');
        }

        async function loadPayouts() {
            const filter = document.getElementById('payoutFilter').value;
            const data = await api(`/payouts${filter ? '?status=' + filter : ''}`);
            if (!data) return;

            const tbody = document.getElementById('payoutsTable');
            tbody.innerHTML = (data.list || []).map(p => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="p-3">${p.id}</td>
                    <td class="p-3">@${p.username || p.seller_id}</td>
                    <td class="p-3">$${p.amount?.toFixed(2)} ${p.currency}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            p.status === 'completed' ? 'bg-green-600/30 text-green-400' :
                            p.status === 'pending' ? 'bg-yellow-600/30 text-yellow-400' :
                            'bg-red-600/30 text-red-400'
                        }">${p.status}</span>
                    </td>
                    <td class="p-3 text-gray-400 text-sm">${new Date(p.requested_at * 1000).toLocaleDateString()}</td>
                    <td class="p-3">
                        ${p.status === 'pending' ? `
                            <button onclick="processPayout(${p.id})" class="text-green-400">Process</button>
                            <button onclick="rejectPayout(${p.id})" class="ml-2 text-red-400">Reject</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function processPayout(id) { const tx = prompt('Transaction hash:'); await api(`/payouts/${id}/process?tx_hash=${tx||''}`, { method: 'POST' }); loadPayouts(); }
        async function rejectPayout(id) { if (confirm('Reject?')) { await api(`/payouts/${id}/reject`, { method: 'POST' }); loadPayouts(); } }

        async function loadLicenses() {
            const data = await api('/licenses');
            if (!data) return;

            const tbody = document.getElementById('licensesTable');
            tbody.innerHTML = (data.list || []).map(l => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="p-3 font-mono text-sm">${l.key}</td>
                    <td class="p-3">${l.type}</td>
                    <td class="p-3">${l.user_id || 'Unassigned'}</td>
                    <td class="p-3 text-gray-400 text-sm">${l.expires_at || 'N/A'}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${l.is_active ? 'bg-green-600/30 text-green-400' : 'bg-red-600/30 text-red-400'}">${l.is_active ? 'Active' : 'Revoked'}</span>
                    </td>
                    <td class="p-3"><button onclick="revokeLicense('${l.key}')" class="text-red-400">Revoke</button></td>
                </tr>
            `).join('');
        }

        function showCreateLicense() { document.getElementById('licenseModal').classList.remove('hidden'); }
        function hideLicenseModal() { document.getElementById('licenseModal').classList.add('hidden'); }
        
        async function createLicense() {
            const type = document.getElementById('licenseType').value;
            const days = parseInt(document.getElementById('licenseDays').value) || 30;
            const userId = document.getElementById('licenseUserId').value || null;
            const result = await api('/licenses', {
                method: 'POST',
                body: JSON.stringify({ license_type: type, days, user_id: userId ? parseInt(userId) : null })
            });
            if (result?.license_key) { alert('Created: ' + result.license_key); hideLicenseModal(); loadLicenses(); }
        }

        async function revokeLicense(key) { if (confirm('Revoke?')) { await api(`/licenses/${encodeURIComponent(key)}`, { method: 'DELETE' }); loadLicenses(); } }

        // ========================
        // FINANCES TAB FUNCTIONS
        // ========================
        let revenueChart = null;
        let currentTxPage = 1;
        let currentFinancePeriod = 'month';

        async function financeApi(endpoint, options = {}) {
            const res = await fetch(`/api/finance${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (res.status === 403) {
                alert('Admin access required');
                return null;
            }
            return res.json();
        }

        async function loadFinances(period = 'month') {
            currentFinancePeriod = period;
            
            // Update period buttons UI
            document.querySelectorAll('.period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.remove('bg-gray-700');
                    btn.classList.add('bg-purple-600');
                } else {
                    btn.classList.remove('bg-purple-600');
                    btn.classList.add('bg-gray-700');
                }
            });

            const data = await financeApi(`/dashboard?period=${period}`);
            if (!data || !data.success) return;

            // Update revenue cards
            document.getElementById('totalRevenuePeriod').textContent = data.revenue?.total_usd?.toFixed(2) || '0.00';
            document.getElementById('transactionCount').textContent = data.revenue?.transactions || 0;
            document.getElementById('mrrValue').textContent = data.revenue?.mrr?.toFixed(0) || '0';
            document.getElementById('arrValue').textContent = data.revenue?.arr?.toFixed(0) || '0';
            
            // Subscriptions
            document.getElementById('activeSubsCount').textContent = data.subscriptions?.total_active || 0;
            document.getElementById('premiumSubsCount').textContent = data.subscriptions?.premium || 0;
            
            // ELC tokens
            document.getElementById('trcPurchased').textContent = data.trc_tokens?.purchased?.toFixed(2) || '0';

            // Payment methods
            const pmList = document.getElementById('paymentMethodsList');
            const paymentMethods = data.payment_methods || {};
            if (Object.keys(paymentMethods).length === 0) {
                pmList.innerHTML = '<p class="text-gray-500">No transactions in this period</p>';
            } else {
                pmList.innerHTML = Object.entries(paymentMethods).map(([method, info]) => `
                    <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">${getMethodIcon(method)}</span>
                            <span class="capitalize">${method}</span>
                        </div>
                        <div class="text-right">
                            <p class="text-green-400 font-bold">$${info.total_usd?.toFixed(2) || 0}</p>
                            <p class="text-gray-500 text-xs">${info.count} txs</p>
                        </div>
                    </div>
                `).join('');
            }

            // Subscription breakdown
            const subBreakdown = document.getElementById('subscriptionBreakdown');
            const subs = data.subscriptions || {};
            subBreakdown.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-purple-900/30 rounded-lg text-center">
                        <p class="text-2xl font-bold text-purple-400">${subs.premium || 0}</p>
                        <p class="text-xs text-gray-400">Premium</p>
                    </div>
                    <div class="p-3 bg-blue-900/30 rounded-lg text-center">
                        <p class="text-2xl font-bold text-blue-400">${subs.basic || 0}</p>
                        <p class="text-xs text-gray-400">Basic</p>
                    </div>
                    <div class="p-3 bg-gray-800/50 rounded-lg text-center">
                        <p class="text-2xl font-bold text-gray-400">${subs.trial || 0}</p>
                        <p class="text-xs text-gray-400">Trial</p>
                    </div>
                    <div class="p-3 bg-yellow-900/30 rounded-lg text-center">
                        <p class="text-2xl font-bold text-yellow-400">${subs.lifetime || 0}</p>
                        <p class="text-xs text-gray-400">Lifetime</p>
                    </div>
                </div>
            `;

            // Load chart and transactions
            loadRevenueChart();
            loadTransactions();
            loadPendingPaymentsCount();
        }

        function getMethodIcon(method) {
            const icons = {
                'elc': 'üíé', 'ton': 'üí†', 'usdt': 'üíµ', 'crypto': '‚Çø',
                'card': 'üí≥', 'bank': 'üè¶', 'unknown': '‚ùì'
            };
            return icons[method?.toLowerCase()] || 'üí∞';
        }

        async function loadRevenueChart() {
            const groupBy = document.getElementById('chartGroupBy').value;
            const data = await financeApi(`/revenue/chart?period=${currentFinancePeriod}&group_by=${groupBy}`);
            if (!data || !data.success) return;

            const chartData = data.data || [];
            const labels = chartData.map(d => d.date);
            const revenues = chartData.map(d => d.revenue);

            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue ($)',
                        data: revenues,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        async function loadTransactions(page = 1) {
            currentTxPage = page;
            const status = document.getElementById('txStatusFilter').value;
            const data = await financeApi(`/transactions?page=${page}&limit=20${status ? '&status=' + status : ''}`);
            if (!data || !data.success) return;

            const tbody = document.getElementById('transactionsTable');
            if (!data.transactions || data.transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No transactions found</td></tr>';
                return;
            }

            tbody.innerHTML = data.transactions.map(tx => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50 text-sm">
                    <td class="p-3 text-gray-400">${tx.timestamp ? new Date(tx.timestamp).toLocaleDateString() : 'N/A'}</td>
                    <td class="p-3">@${tx.username || 'N/A'}</td>
                    <td class="p-3">${tx.type}</td>
                    <td class="p-3"><span class="text-lg">${getMethodIcon(tx.payment_method)}</span> ${tx.payment_method}</td>
                    <td class="p-3 text-green-400 font-medium">$${tx.amount_usd?.toFixed(2) || 0}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs ${getStatusClass(tx.status)}">${tx.status}</span>
                    </td>
                    <td class="p-3">
                        ${tx.status === 'completed' ? `<button onclick="refundPayment(${tx.id})" class="text-red-400 hover:text-red-300 text-xs">Refund</button>` : ''}
                        ${tx.status === 'pending' ? `<button onclick="approvePayment(${tx.id})" class="text-green-400 hover:text-green-300 text-xs">Approve</button>` : ''}
                    </td>
                </tr>
            `).join('');

            // Pagination
            const totalPages = data.pages || 1;
            const pagination = document.getElementById('txPagination');
            if (totalPages > 1) {
                pagination.innerHTML = Array.from({length: Math.min(totalPages, 10)}, (_, i) => i + 1)
                    .map(p => `<button onclick="loadTransactions(${p})" class="px-3 py-1 rounded ${p === page ? 'bg-purple-600' : 'bg-gray-700'}">${p}</button>`)
                    .join('');
            } else {
                pagination.innerHTML = '';
            }
        }

        function getStatusClass(status) {
            const classes = {
                'completed': 'bg-green-600/30 text-green-400',
                'pending': 'bg-yellow-600/30 text-yellow-400',
                'failed': 'bg-red-600/30 text-red-400',
                'refunded': 'bg-purple-600/30 text-purple-400'
            };
            return classes[status] || 'bg-gray-600/30 text-gray-400';
        }

        async function loadPendingPaymentsCount() {
            const data = await financeApi('/pending-payments');
            if (data && data.success) {
                document.getElementById('pendingPaymentsCount').textContent = data.count || 0;
            }
        }

        async function loadPendingPayments() {
            const data = await financeApi('/pending-payments');
            if (!data || !data.success) return;

            if (!data.payments || data.payments.length === 0) {
                alert('No pending payments');
                return;
            }

            // Show pending payments in modal
            const html = data.payments.map(p => `
                <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded mb-2">
                    <div>
                        <p class="font-medium">@${p.username}</p>
                        <p class="text-sm text-gray-400">${p.type} - ${p.payment_method}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-green-400 font-bold">$${p.amount_usd?.toFixed(2)}</p>
                        <button onclick="approvePayment(${p.id})" class="text-xs text-green-400 hover:underline">Approve</button>
                    </div>
                </div>
            `).join('');
            
            showModal('Pending Payments', html);
        }

        async function approvePayment(id) {
            if (!confirm('Approve this payment and activate subscription?')) return;
            const result = await financeApi(`/payments/${id}/approve`, { method: 'POST' });
            if (result && result.success) {
                alert(`Payment approved! Subscription activated until ${result.expires}`);
                loadFinances(currentFinancePeriod);
            } else {
                alert('Failed: ' + (result?.detail || 'Unknown error'));
            }
        }

        async function refundPayment(id) {
            const reason = prompt('Refund reason:');
            if (!reason || reason.length < 5) {
                alert('Please provide a valid reason (min 5 chars)');
                return;
            }
            const result = await financeApi(`/payments/${id}/refund?reason=${encodeURIComponent(reason)}`, { method: 'POST' });
            if (result && result.success) {
                alert(`Refunded $${result.refund_amount}`);
                loadTransactions(currentTxPage);
            } else {
                alert('Failed: ' + (result?.detail || 'Unknown error'));
            }
        }

        function showExportModal() {
            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            
            showModal('Export Financial Data', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Start Date</label>
                            <input type="date" id="exportStart" value="${monthAgo}" class="w-full px-3 py-2 bg-gray-800 rounded border border-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">End Date</label>
                            <input type="date" id="exportEnd" value="${today}" class="w-full px-3 py-2 bg-gray-800 rounded border border-gray-700">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Format</label>
                        <select id="exportFormat" class="w-full px-3 py-2 bg-gray-800 rounded border border-gray-700">
                            <option value="csv">CSV (Excel compatible)</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    <button onclick="doExport()" class="w-full py-2 bg-green-600 rounded-lg hover:bg-green-700">
                        üì• Download Export
                    </button>
                </div>
            `);
        }

        async function doExport() {
            const startDate = document.getElementById('exportStart').value;
            const endDate = document.getElementById('exportEnd').value;
            const format = document.getElementById('exportFormat').value;

            const result = await financeApi('/export', {
                method: 'POST',
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate,
                    export_type: 'transactions',
                    format: format
                })
            });

            if (!result || !result.success) {
                alert('Export failed');
                return;
            }

            if (format === 'csv') {
                // Download CSV
                const blob = new Blob([result.content], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = result.filename || 'export.csv';
                a.click();
                URL.revokeObjectURL(url);
            } else {
                // Download JSON
                const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `financial_export_${startDate}_${endDate}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            hideModal();
            alert('Export downloaded!');
        }

        // Generic modal functions
        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.id = 'genericModal';
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass rounded-xl p-6 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">${title}</h3>
                        <button onclick="hideModal()" class="text-gray-400 hover:text-white">&times;</button>
                    </div>
                    ${content}
                </div>
            `;
            document.body.appendChild(modal);
        }

        function hideModal() {
            const modal = document.getElementById('genericModal');
            if (modal) modal.remove();
        }

        function logout() { localStorage.removeItem('token'); window.location.href = '/login'; }

        loadOverview();
    </script>
</body>
</html>
