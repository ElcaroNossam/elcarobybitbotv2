# ğŸ”€ Trading Streams Architecture
# ElCaro Trading Platform - ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ²
# ================================================
# Ğ’ĞµÑ€ÑĞ¸Ñ: 1.0 | 20 ÑĞ½Ğ²Ğ°Ñ€Ñ 2026

---

## ğŸ“Š ĞĞ‘Ğ©ĞĞ¯ Ğ¡Ğ¥Ğ•ĞœĞ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER (Telegram ID)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                                         â”‚
           â–¼                                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      BYBIT (CEX)        â”‚                             â”‚   HYPERLIQUID (DEX)     â”‚
â”‚  exchange = 'bybit'     â”‚                             â”‚  exchange = 'hyperliquid'â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                                         â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                             â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
     â”‚           â”‚                                             â”‚           â”‚
     â–¼           â–¼                                             â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DEMO   â”‚ â”‚  REAL   â”‚                                 â”‚ TESTNET  â”‚ â”‚ MAINNET  â”‚
â”‚ account â”‚ â”‚ account â”‚                                 â”‚ account  â”‚ â”‚ account  â”‚
â”‚ ='demo' â”‚ â”‚ ='real' â”‚                                 â”‚='testnet'â”‚ â”‚='mainnet'â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚           â”‚                                             â”‚           â”‚
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚                                                         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           5 Ğ¡Ğ¢Ğ ĞĞ¢Ğ•Ğ“Ğ˜Ğ™                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   OI    â”‚ â”‚ Scryptomera â”‚ â”‚ Scalper â”‚ â”‚ ElCaro  â”‚ â”‚  Fibonacci  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚                â”‚
                    â–¼                â–¼                â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ direction â”‚    â”‚ direction â”‚    â”‚ direction â”‚
             â”‚  = 'all'  â”‚    â”‚  = 'long' â”‚    â”‚ = 'short' â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¢ Ğ ĞĞ¡Ğ§ĞĞ¢ ĞŸĞĞ¢ĞĞšĞĞ’

### Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ°:
```
ĞŸĞĞ¢ĞĞšĞ˜ = Ğ‘Ğ¸Ñ€Ğ¶Ğ¸ Ã— ĞĞºĞºĞ°ÑƒĞ½Ñ‚Ñ‹ Ã— Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ã— ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
       = 2 Ã— 2 Ã— 5 Ã— 3
       = 60 Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ² Ğ½Ğ° ÑĞ·ĞµÑ€Ğ°
```

### Ğ ĞµĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:
- Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğ½ÑÑ‚Ğ²Ğ¾ ÑĞ·ĞµÑ€Ğ¾Ğ² Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ **1 Ğ±Ğ¸Ñ€Ğ¶Ñƒ** (Bybit Ğ˜Ğ›Ğ˜ HyperLiquid)
- Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğ½ÑÑ‚Ğ²Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ **1 Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚** (Demo Ğ˜Ğ›Ğ˜ Real)
- Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğ½ÑÑ‚Ğ²Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ **1-2 ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸**
- ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ `'all'` (Ğ½Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ÑÑÑ‚ Long/Short)

**Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ÑĞ·ĞµÑ€: 1 Ã— 1 Ã— 2 Ã— 1 = 2 Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°**

---

## ğŸ—„ï¸ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ Ğ‘Ğ”

### Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: `user_strategy_settings`

```sql
PRIMARY KEY: (user_id, strategy, exchange, account_type)
```

| ĞŸĞ¾Ğ»Ğµ | Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|-----|----------|
| **user_id** | BIGINT | Telegram ID |
| **strategy** | TEXT | 'oi', 'scryptomera', 'scalper', 'elcaro', 'fibonacci' |
| **exchange** | TEXT | 'bybit', 'hyperliquid' |
| **account_type** | TEXT | 'demo', 'real' (Bybit) / 'testnet', 'mainnet' (HL) |
| enabled | BOOLEAN | Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ° Ğ»Ğ¸ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ |
| direction | TEXT | 'all', 'long', 'short' |
| **percent** | REAL | Entry % (Ğ¾Ğ±Ñ‰Ğ¸Ğ¹) |
| **sl_percent** | REAL | Stop-Loss % (Ğ¾Ğ±Ñ‰Ğ¸Ğ¹) |
| **tp_percent** | REAL | Take-Profit % (Ğ¾Ğ±Ñ‰Ğ¸Ğ¹) |
| leverage | INTEGER | ĞŸĞ»ĞµÑ‡Ğ¾ |
| **long_percent** | REAL | Entry % Ğ´Ğ»Ñ Long |
| **long_sl_percent** | REAL | SL % Ğ´Ğ»Ñ Long |
| **long_tp_percent** | REAL | TP % Ğ´Ğ»Ñ Long |
| **short_percent** | REAL | Entry % Ğ´Ğ»Ñ Short |
| **short_sl_percent** | REAL | SL % Ğ´Ğ»Ñ Short |
| **short_tp_percent** | REAL | TP % Ğ´Ğ»Ñ Short |
| use_atr | INTEGER | Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ATR |
| atr_periods | INTEGER | ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ñ‹ ATR |
| atr_multiplier_sl | REAL | ĞœĞ½Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ ATR Ğ´Ğ»Ñ SL |
| atr_trigger_pct | REAL | Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ ATR trailing |
| coins_group | TEXT | Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ¼Ğ¾Ğ½ĞµÑ‚ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ |
| order_type | TEXT | 'market', 'limit' |

### Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Side-Specific Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº:

```python
# ĞŸÑ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ LONG Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸:
if side == "Buy":
    entry_pct = settings.get("long_percent") or settings.get("percent")
    sl_pct = settings.get("long_sl_percent") or settings.get("sl_percent")
    tp_pct = settings.get("long_tp_percent") or settings.get("tp_percent")

# ĞŸÑ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ SHORT Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸:
if side == "Sell":
    entry_pct = settings.get("short_percent") or settings.get("percent")
    sl_pct = settings.get("short_sl_percent") or settings.get("sl_percent")
    tp_pct = settings.get("short_tp_percent") or settings.get("tp_percent")
```

---

## ğŸ”„ ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ¡Ğ˜Ğ“ĞĞĞ›ĞĞ’

### ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ ÑĞ¸Ğ³Ğ½Ğ°Ğ»:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ğ¡Ğ˜Ğ“ĞĞĞ›     â”‚
â”‚ strategy=OI  â”‚
â”‚ side=Buy     â”‚
â”‚ symbol=BTC   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ exchange_type ÑĞ·ĞµÑ€Ğ°                                  â”‚
â”‚     exchange = db.get_exchange_type(uid)  # 'bybit'              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ trading_mode ÑĞ·ĞµÑ€Ğ°                                   â”‚
â”‚     mode = db.get_trading_mode(uid)  # 'demo' / 'real' / 'both'  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ target accounts                                    â”‚
â”‚     if mode == 'both':                                           â”‚
â”‚         targets = ['demo', 'real']  # Ğ¸Ğ»Ğ¸ ['testnet', 'mainnet'] â”‚
â”‚     else:                                                         â”‚
â”‚         targets = [mode]                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ target account:                                   â”‚
â”‚     settings = db.get_strategy_settings(uid, 'oi', exchange, acc)â”‚
â”‚     if settings.get('enabled'):                                   â”‚
â”‚         if settings.get('direction') in ['all', 'long']:         â”‚
â”‚             open_position(...)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ™

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 1: ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ ÑĞ·ĞµÑ€ (1 Ğ¿Ğ¾Ñ‚Ğ¾Ğº)
```
user_id: 123456
exchange: bybit
trading_mode: demo
strategy: OI (enabled)
direction: all
```
**Ğ—Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² user_strategy_settings: 1**

---

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 2: ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹ ÑĞ·ĞµÑ€ (4 Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ°)
```
user_id: 789012
exchange: bybit
trading_mode: both (demo + real)
strategies: OI, Scryptomera (enabled)
direction: all
```
**Ğ—Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² user_strategy_settings: 4**
- (789012, 'oi', 'bybit', 'demo')
- (789012, 'oi', 'bybit', 'real')
- (789012, 'scryptomera', 'bybit', 'demo')
- (789012, 'scryptomera', 'bybit', 'real')

---

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 3: ĞŸÑ€Ğ¾Ñ„Ğ¸ Ñ Long/Short Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼ (8 Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ²)
```
user_id: 456789
exchange: bybit
trading_mode: both
strategies: OI, Scryptomera
OI: direction=all (Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸)
Scryptomera: Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ long_percent/short_percent
```
**Ğ—Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² user_strategy_settings: 4** (Ğ½Ğ¾ 8 "Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ…" Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ²)
- (456789, 'oi', 'bybit', 'demo') â†’ direction=all
- (456789, 'oi', 'bybit', 'real') â†’ direction=all
- (456789, 'scryptomera', 'bybit', 'demo') â†’ long_percent=2%, short_percent=1.5%
- (456789, 'scryptomera', 'bybit', 'real') â†’ long_percent=2%, short_percent=1.5%

---

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 4: ĞœÑƒĞ»ÑŒÑ‚Ğ¸-Ğ±Ğ¸Ñ€Ğ¶Ğ° (Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼)
```
user_id: 111222
exchanges: bybit + hyperliquid
bybit: trading_mode=both (demo + real)
hyperliquid: testnet + mainnet
strategies: Ğ²ÑĞµ 5
```
**Ğ—Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² user_strategy_settings: 20** (Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼)
- 5 strategies Ã— 2 exchanges Ã— 2 accounts = 20

---

## ğŸ¯ QUICK REFERENCE

### ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸:
```python
from db import get_strategy_settings

# ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ
settings = get_strategy_settings(
    user_id=123456,
    strategy='oi',
    exchange='bybit',
    account_type='demo'
)
```

### ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½ÑƒÑ Ğ±Ğ¸Ñ€Ğ¶Ñƒ ÑĞ·ĞµÑ€Ğ°:
```python
from db import get_exchange_type, get_trading_mode

exchange = get_exchange_type(uid)      # 'bybit' | 'hyperliquid'
mode = get_trading_mode(uid)           # 'demo' | 'real' | 'both'
```

### ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ 'both':
```python
from db import _normalize_both_account_type

# 'both' â†’ 'demo' (Bybit) Ğ¸Ğ»Ğ¸ 'testnet' (HL)
acc = _normalize_both_account_type('both', exchange='bybit')  # â†’ 'demo'
acc = _normalize_both_account_type('both', exchange='hyperliquid')  # â†’ 'testnet'
```

### ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Side-Specific Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸:
```python
# Ğ”Ğ»Ñ LONG (side='Buy')
entry = settings.get('long_percent') or settings.get('percent')
sl = settings.get('long_sl_percent') or settings.get('sl_percent')

# Ğ”Ğ»Ñ SHORT (side='Sell')
entry = settings.get('short_percent') or settings.get('percent')
sl = settings.get('short_sl_percent') or settings.get('sl_percent')
```

---

## ğŸ”§ FALLBACK Ğ›ĞĞ“Ğ˜ĞšĞ (ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ)

### ĞĞ¾Ğ²Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ 'default':

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Ğ Ğ°Ğ½ÑŒÑˆĞµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸ÑÑŒ - Ğ¾Ğ´Ğ½Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¸ÑĞ°Ğ»Ğ¾ÑÑŒ Ğ² demo Ğ˜ real.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ğ¸ÑˆÑƒÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ² `account_type='default'`, Ğ° Ñ‡Ğ¸Ñ‚Ğ°ÑÑ‚ÑÑ Ñ ĞºĞ°ÑĞºĞ°Ğ´Ğ¾Ğ¼:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ—ĞĞŸĞ˜Ğ¡Ğ¬ (set_strategy_setting)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¸ÑˆĞµÑ‚ Ğ² account_type='default'                           â”‚
â”‚  Ğ­Ñ‚Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ ĞºĞ¾ Ğ’Ğ¡Ğ•Ğœ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°Ğ¼ Ñ‡ĞµÑ€ĞµĞ· fallback            â”‚
â”‚                                                                         â”‚
â”‚  Ğ”Ğ»Ñ per-account override: sync_all_accounts=False                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ§Ğ¢Ğ•ĞĞ˜Ğ• (get_strategy_settings)                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚  ĞšĞ°ÑĞºĞ°Ğ´ fallback:                                                       â”‚
â”‚                                                                         â”‚
â”‚  1. EXACT MATCH: (user, strategy, exchange, account_type)              â”‚
â”‚     â””â”€> Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ´Ğ»Ñ demo/real - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ   â”‚
â”‚         _source = "account"                                            â”‚
â”‚                                                                         â”‚
â”‚  2. EXCHANGE DEFAULT: (user, strategy, exchange, 'default')            â”‚
â”‚     â””â”€> Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ per-account, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ default Ğ´Ğ»Ñ Ğ±Ğ¸Ñ€Ğ¶Ğ¸          â”‚
â”‚         _source = "exchange"                                           â”‚
â”‚                                                                         â”‚
â”‚  3. GLOBAL DEFAULT: (user, strategy, 'default', 'default')             â”‚
â”‚     â””â”€> Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸                             â”‚
â”‚         _source = "global"                                             â”‚
â”‚                                                                         â”‚
â”‚  4. USER DEFAULTS: users.* (Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ·ĞµÑ€Ğ°)                â”‚
â”‚         _source = "user"                                               â”‚
â”‚                                                                         â”‚
â”‚  5. SYSTEM DEFAULTS: coin_params.py                                    â”‚
â”‚         _source = "system"                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:

```python
# Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ (Ğ¿Ğ¸ÑˆĞµÑ‚ÑÑ Ğ² 'default' Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸)
db.set_strategy_setting(uid, 'oi', 'sl_percent', 3.5, exchange='bybit')

# Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ñ fallback - Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ´Ğ»Ñ demo Ğ˜ real
settings = db.get_strategy_settings(uid, 'oi', 'bybit', 'demo')
print(settings['sl_percent'])  # 3.5
print(settings['_source'])     # 'exchange' (Ğ¸Ğ· bybit:default)

# Per-account override (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ñ… ÑĞ·ĞµÑ€Ğ¾Ğ²)
db.set_strategy_setting(uid, 'oi', 'sl_percent', 5.0, 
                        exchange='bybit', account_type='real',
                        sync_all_accounts=False)  # <-- Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ sync

# Ğ¢ĞµĞ¿ĞµÑ€ÑŒ demo Ğ¸ real Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ
demo_settings = db.get_strategy_settings(uid, 'oi', 'bybit', 'demo')
real_settings = db.get_strategy_settings(uid, 'oi', 'bybit', 'real')
print(demo_settings['sl_percent'])  # 3.5 (Ğ¸Ğ· exchange:default)
print(real_settings['sl_percent'])  # 5.0 (Ğ¸Ğ· account:real)
```

### Ğ¡Ñ‚Ğ°Ñ€Ğ°Ñ vs ĞĞ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°:

| Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ | Ğ‘Ñ‹Ğ»Ğ¾ (Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ) | Ğ¡Ñ‚Ğ°Ğ»Ğ¾ (fallback) |
|----------|---------------------|------------------|
| Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ SL=3% | 2 Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸: demo=3%, real=3% | 1 Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ: default=3% |
| Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ SL=5% | 2 UPDATE: demo=5%, real=5% | 1 UPDATE: default=5% |
| Override Ğ´Ğ»Ñ Real | - | 1 Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ: real=5% (demo=3% Ñ‡ĞµÑ€ĞµĞ· fallback) |

### ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:

1. **ĞœĞµĞ½ÑŒÑˆĞµ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² Ğ² Ğ‘Ğ”** - Ñ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ÑĞ·ĞµÑ€: 1 Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ 4
2. **ĞÑ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ** - Ğ¾Ğ´Ğ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ²ĞµĞ·Ğ´Ğµ
3. **Ğ“Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ** - Ğ¿Ñ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğµ ÑĞ·ĞµÑ€Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ per-account
4. **ĞŸÑ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ** - `_source` Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ²Ğ·ÑÑ‚Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ

---

## ğŸ“ˆ ĞœĞĞĞ˜Ğ¢ĞĞ Ğ˜ĞĞ“ ĞŸĞĞ¢ĞĞšĞĞ’

### SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:

```sql
-- Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° ÑĞ·ĞµÑ€Ğ°
SELECT user_id, COUNT(*) as streams
FROM user_strategy_settings
WHERE enabled = true
GROUP BY user_id
ORDER BY streams DESC;

-- ĞšĞ°ĞºĞ¸Ğµ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹
SELECT strategy, COUNT(DISTINCT user_id) as users
FROM user_strategy_settings
WHERE enabled = true
GROUP BY strategy
ORDER BY users DESC;

-- Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ğ±Ğ¸Ñ€Ğ¶Ğ°Ğ¼
SELECT exchange, account_type, COUNT(*) as count
FROM user_strategy_settings
WHERE enabled = true
GROUP BY exchange, account_type;

-- Ğ—Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ account_type='default' (Ğ½Ğ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°)
SELECT user_id, strategy, exchange, account_type
FROM user_strategy_settings
WHERE account_type = 'default';

-- Ğ—Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ per-account override
SELECT user_id, strategy, exchange, account_type
FROM user_strategy_settings
WHERE account_type NOT IN ('default');
```

---

*ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: 20 ÑĞ½Ğ²Ğ°Ñ€Ñ 2026*
*Ğ’ĞµÑ€ÑĞ¸Ñ: 1.1 - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ fallback Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ñ 'default'*
